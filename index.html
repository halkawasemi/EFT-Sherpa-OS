<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EFT Sherpa OS v0.63</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        tarkov: {
                            bg: '#0f0f0f',
                            panel: '#151515',
                            border: '#333333',
                            text: '#cccccc',
                            accent: '#9a8c7d', 
                            accentHover: '#b09b75',
                            green: '#4ade80',
                            red: '#ef4444',
                            orange: '#f97316',
                            gold: '#ffd700',
                            blue: '#4a6fa5'
                        }
                    },
                    fontFamily: {
                        mono: ['Consolas', 'Monaco', 'Courier New', 'monospace'],
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #050505; color: #d4d4d4; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
        
        /* CRT Overlay */
        .crt-overlay {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 40;
        }

        .glass-panel { background: rgba(26, 26, 26, 0.95); border: 1px solid #333; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .loader { border: 2px solid #333; border-top: 2px solid #9a8c7d; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animation */
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile Nav Active State */
        .mobile-nav-active { color: #9a8c7d; border-top: 2px solid #9a8c7d; background: linear-gradient(to bottom, rgba(154, 140, 125, 0.1), transparent); }

        /* --- Market Monitor Specific Styles --- */
        .req-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 3px; font-weight: bold; letter-spacing: 0.05em; display: inline-flex; align-items: center; gap: 4px; margin-right: 4px; transition: all 0.3s; }
        
        /* Active States */
        .req-quest { background: rgba(234, 179, 8, 0.2); color: #fbbf24; border: 1px solid rgba(234, 179, 8, 0.4); }
        .req-hideout { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.4); }
        .req-barter { background: rgba(192, 132, 252, 0.2); color: #c084fc; border: 1px solid rgba(192, 132, 252, 0.4); }
        .req-craft { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.4); }
        
        /* Phase 3: Inactive/Completed States */
        .req-done { background: rgba(60, 60, 60, 0.2); color: #666; border: 1px solid rgba(60, 60, 60, 0.4); opacity: 0.6; }
        .req-done-text { text-decoration: line-through; opacity: 0.6; }
        
        .profit-pos { color: #4ade80; }
        .profit-neg { color: #ef4444; }
        
        /* Market Accordion */
        .detail-section { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out, margin-top 0.3s; }
        .market-card.expanded .detail-section { max-height: 2000px; opacity: 1; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #444; }
        .market-card.expanded { background-color: #1a1a1a; border-color: #4a6fa5; box-shadow: 0 0 15px rgba(74, 111, 165, 0.1); }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Market Tab Navigation */
        .market-nav-tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; color: #666; border-bottom: 2px solid transparent; transition: all 0.3s; font-weight: bold; font-size: 0.8rem; background: transparent; }
        .market-nav-tab:hover { background: rgba(255,255,255,0.05); }
        .market-nav-tab.active { color: #9a8c7d; border-bottom-color: #9a8c7d; background: linear-gradient(to top, rgba(154, 140, 125, 0.1), transparent); }
        
        /* Hideout Specific */
        .hideout-level-btn { width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: #222; color: #666; transition: all 0.2s; }
        .hideout-level-btn:hover:not(:disabled) { background: #333; color: #fff; }
        .hideout-level-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Filter Checkbox Button Style (Phase 4) */
        .filter-toggle-btn {
            font-size: 0.75rem; padding: 4px 10px; border-radius: 4px; border: 1px solid #333; background: #1a1a1a; color: #666; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .filter-toggle-btn.active {
            background: rgba(154, 140, 125, 0.2); border-color: #9a8c7d; color: #9a8c7d;
        }
        .filter-toggle-btn:hover:not(.active) { background: #252525; color: #aaa; }
        
        /* Safe Area for iPhone */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Wishlist Star */
        .wishlist-star { cursor: pointer; transition: transform 0.2s; }
        .wishlist-star:hover { transform: scale(1.2); }
        .wishlist-star.active { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }

        /* Settings specific */
        .trader-avatar-box { position: relative; }
        .trader-avatar-box img { filter: grayscale(100%); transition: all 0.3s; }
        .trader-avatar-box.active img { filter: grayscale(0%); }
        .trader-level-selector select { appearance: none; text-align: center; }
        
        /* Craft Cost Detail */
        .cost-source-trader { color: #4ade80; }
        .cost-source-flea { color: #f97316; }

        /* Injector Specific (Integrated) */
        .injector-btn { transition: all 0.3s; border: 1px solid #333; position: relative; overflow: hidden; }
        .injector-btn:hover { border-color: #666; background: rgba(255,255,255,0.05); }
        .injector-btn.active { border-color: #a855f7; background: rgba(168, 85, 247, 0.1); box-shadow: 0 0 15px rgba(168, 85, 247, 0.1); }
        .injector-grid-cell { aspect-ratio: 1/1; background: radial-gradient(circle at center, #2a2a2a 0%, #111 100%); border: 1px solid #333; position: relative; display: flex; align-items: center; justify-content: center; border-radius: 4px; overflow: hidden; }
        .injector-grid-cell img { transition: transform 0.2s; }
        .injector-grid-cell:hover img { transform: scale(1.1); }
        .injector-grid-cell:hover .remove-overlay { opacity: 1; }
        .remove-overlay { opacity: 0; background: rgba(0,0,0,0.7); position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; cursor: pointer; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden relative text-sm md:text-base">
    
    <div class="crt-overlay fixed inset-0 h-full w-full pointer-events-none"></div>

    <!-- Header -->
    <header class="h-14 bg-tarkov-panel border-b border-tarkov-border flex items-center justify-between px-4 md:px-6 z-50 shrink-0 shadow-md">
        <div class="flex items-center gap-2 md:gap-3">
            <i class="fa-solid fa-layer-group text-tarkov-accent text-lg md:text-xl"></i>
            <h1 class="font-bold text-base md::text-lg tracking-wider text-tarkov-accent">EFT SHERPA <span class="text-white opacity-60">OS</span> v0.63 <span id="header-mode-badge" class="text-[10px] bg-tarkov-green text-black px-1 rounded ml-1 align-top transition-colors">PvE</span></h1>
        </div>
        
        <div class="flex items-center gap-2 md:gap-4">
            <button id="sync-btn" class="text-xs flex items-center gap-2 bg-tarkov-border hover:bg-gray-700 transition px-3 py-2 rounded text-gray-300 border border-tarkov-border active:scale-95">
                <i class="fa-solid fa-rotate"></i> <span class="hidden md:inline">SYNC</span>
            </button>
            <button class="nav-btn-shortcut text-gray-400 hover:text-white transition px-2 py-2" data-target="settings" title="Settings">
                <i class="fa-solid fa-gear text-lg"></i>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- Sidebar (PC) -->
        <nav class="w-64 bg-tarkov-panel border-r border-tarkov-border flex flex-col z-30 hidden md:flex">
            <div class="p-4 border-b border-tarkov-border">
                <div class="text-xs text-gray-500 uppercase font-bold mb-2">Command</div>
                <button class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 bg-tarkov-border text-tarkov-accent border-l-2 border-tarkov-accent font-medium" data-target="dashboard">
                    <i class="fa-solid fa-chart-line w-6 text-center"></i> Dashboard
                </button>
                <button class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="market">
                    <i class="fa-solid fa-shop w-6 text-center"></i> Market & Craft
                </button>
                <button class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="wishlist">
                    <i class="fa-solid fa-star w-6 text-center"></i> Wishlist
                </button>
                <button class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="tasks">
                    <i class="fa-solid fa-list-check w-6 text-center"></i> Task Database
                </button>
                <button class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="hideout">
                    <i class="fa-solid fa-dungeon w-6 text-center"></i> Hideout Manager
                </button>
                <button class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="gunsmith">
                    <i class="fa-solid fa-gun w-6 text-center"></i> Gunsmith
                </button>
                <button class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="ammo">
                    <i class="fa-solid fa-bullseye w-6 text-center"></i> Ballistics Live
                </button>
                <button class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="loadout">
                    <i class="fa-solid fa-briefcase-medical w-6 text-center"></i> Loadout
                </button>
                <div class="my-2 border-t border-gray-800"></div>
                <button class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="settings">
                    <i class="fa-solid fa-gear w-6 text-center"></i> System Config
                </button>
            </div>
            
            <div class="p-4 text-[10px] text-gray-600 text-center mt-auto">
                INTEGRATED SYSTEM<br>
                v0.63 (Injector Presets)
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 bg-tarkov-bg overflow-y-auto p-4 md:p-6 pb-32 md:pb-6 relative scroll-smooth" id="main-content">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="space-y-4 md:space-y-6 animate-fade-in">
                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                    <div class="glass-panel p-3 md:p-4 rounded">
                        <div class="text-gray-400 text-[10px] md:text-xs uppercase">DB Status</div>
                        <div class="text-sm md:text-base font-bold text-gray-500 mt-1" id="dash-status">Offline</div>
                    </div>
                    <div class="glass-panel p-3 md:p-4 rounded">
                        <div class="text-gray-400 text-[10px] md:text-xs uppercase">Live Tasks</div>
                        <div class="text-xl md:text-2xl font-bold text-white mt-1" id="dash-task-count">0</div>
                    </div>
                    <div class="glass-panel p-3 md:p-4 rounded">
                        <div class="text-gray-400 text-[10px] md:text-xs uppercase">Market Intel</div>
                        <div class="text-xl md:text-2xl font-bold text-tarkov-blue mt-1" id="dash-market-count">0</div>
                    </div>
                    <div class="glass-panel p-3 md:p-4 rounded">
                        <div class="text-gray-400 text-[10px] md:text-xs uppercase">Hideout</div>
                        <div class="text-xl md:text-2xl font-bold text-tarkov-green mt-1" id="dash-hideout-count">0%</div>
                    </div>
                </div>

                <!-- Shortcuts -->
                <div class="glass-panel p-4 md:p-6 rounded border border-dashed border-gray-700">
                    <h2 class="text-lg md:text-xl text-white mb-2"><i class="fa-solid fa-rocket mr-2"></i>Quick Access</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button class="nav-btn-shortcut flex items-center gap-3 bg-black/40 p-3 rounded hover:bg-white/5 border border-gray-800 hover:border-tarkov-blue transition text-left w-full" data-target="market">
                            <div class="bg-tarkov-blue/20 p-2 rounded text-tarkov-blue"><i class="fa-solid fa-shop"></i></div>
                            <div>
                                <div class="text-sm font-bold text-gray-200">Market Monitor</div>
                                <div class="text-xs text-gray-500">市場価格・クラフト利益 (LL考慮済)</div>
                            </div>
                        </button>
                        <button class="nav-btn-shortcut flex items-center gap-3 bg-black/40 p-3 rounded hover:bg-white/5 border border-gray-800 hover:border-red-500 transition text-left w-full" data-target="ammo">
                            <div class="bg-red-900/20 p-2 rounded text-red-500"><i class="fa-solid fa-bullseye"></i></div>
                            <div>
                                <div class="text-sm font-bold text-gray-200">Ballistics Live</div>
                                <div class="text-xs text-gray-500">弾薬性能・入手価格可視化</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW: SETTINGS -->
            <div id="view-settings" class="hidden space-y-4 md:space-y-6 animate-fade-in">
                <div class="bg-tarkov-panel border border-tarkov-border p-4 md:p-6 rounded shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4"><i class="fa-solid fa-gear mr-2 text-gray-400"></i>SYSTEM CONFIG</h2>
                    
                    <!-- Game Mode -->
                    <div class="mb-8">
                        <h3 class="text-sm font-bold text-tarkov-accent uppercase mb-3 border-b border-gray-800 pb-2">Game Mode</h3>
                        <div class="flex gap-4">
                            <label class="cursor-pointer flex items-center gap-2 bg-black/40 p-3 rounded border border-gray-700 hover:border-gray-500 transition w-full md:w-auto">
                                <input type="radio" name="gameMode" value="pve" class="form-radio text-tarkov-accent focus:ring-tarkov-accent">
                                <div>
                                    <div class="font-bold text-white">PvE Zone</div>
                                    <div class="text-xs text-gray-500">AI PMC Only. Market prices vary.</div>
                                </div>
                            </label>
                            <label class="cursor-pointer flex items-center gap-2 bg-black/40 p-3 rounded border border-gray-700 hover:border-gray-500 transition w-full md:w-auto">
                                <input type="radio" name="gameMode" value="regular" class="form-radio text-tarkov-red focus:ring-tarkov-red">
                                <div>
                                    <div class="font-bold text-white">PvP (Regular)</div>
                                    <div class="text-xs text-gray-500">Standard Online Mode.</div>
                                </div>
                            </label>
                        </div>
                        <div class="mt-2 text-xs text-yellow-500"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Changing mode requires a re-sync (Automatic).</div>
                    </div>

                    <!-- Trader Loyalty -->
                    <div class="mb-8">
                        <h3 class="text-sm font-bold text-tarkov-accent uppercase mb-3 border-b border-gray-800 pb-2">Trader Loyalty Levels (LL)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="settings-trader-grid">
                            <!-- Traders injected via JS -->
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div>
                        <h3 class="text-sm font-bold text-gray-500 uppercase mb-3 border-b border-gray-800 pb-2">Data Management</h3>
                        <button onclick="localStorage.clear(); location.reload();" class="bg-red-900/20 hover:bg-red-900/40 text-red-500 border border-red-900 px-4 py-2 rounded text-xs transition">
                            <i class="fa-solid fa-trash mr-1"></i> Clear All Data & Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW: WISHLIST -->
            <div id="view-wishlist" class="hidden space-y-4 animate-fade-in">
                <div class="bg-tarkov-panel border border-tarkov-border p-4 rounded shadow-lg sticky top-0 z-20">
                    <div class="flex justify-between items-center">
                        <h2 class="text-sm font-bold text-gray-200"><i class="fa-solid fa-star mr-2 text-tarkov-gold"></i>WISHLIST</h2>
                        <span id="wishlist-count" class="text-xs text-gray-500 font-mono">0 Items</span>
                    </div>
                    <div class="text-[10px] text-gray-500 mt-1">Items added from Market are tracked here. Prices update on Sync.</div>
                </div>
                <div id="wishlist-grid" class="grid grid-cols-1 gap-3">
                    <div class="text-center text-gray-500 py-10">No items in wishlist.</div>
                </div>
            </div>

            <!-- VIEW: MARKET MONITOR -->
            <div id="view-market" class="hidden space-y-4 animate-fade-in">
                <div class="glass-panel rounded overflow-hidden">
                    <div class="flex border-b border-gray-700 bg-black/20" role="tablist">
                        <button class="market-nav-tab active" id="mt-items" role="tab" aria-selected="true" data-tab="items"><i class="fa-solid fa-tag mr-1"></i> MARKET</button>
                        <button class="market-nav-tab" id="mt-crafts" role="tab" aria-selected="false" data-tab="crafts"><i class="fa-solid fa-hammer mr-1"></i> CRAFTS</button>
                    </div>
                    <div class="p-4">
                        <div id="subview-items" role="tabpanel">
                            <div class="mb-4 space-y-3">
                                <div class="w-full relative">
                                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                    <input type="text" id="market-search" placeholder="Search Item, Task or Barter..." class="w-full bg-black/40 border border-gray-600 pl-10 pr-4 py-2 rounded text-sm text-white focus:border-tarkov-blue outline-none" aria-label="Search Market">
                                </div>
                                
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <button class="filter-toggle-btn" id="filter-req-task" data-filter="task">
                                        <i class="fa-solid fa-scroll"></i> Task Req
                                    </button>
                                    <button class="filter-toggle-btn" id="filter-req-hideout" data-filter="hideout">
                                        <i class="fa-solid fa-hammer"></i> Hideout Req
                                    </button>
                                    <button class="filter-toggle-btn" id="filter-req-craft" data-filter="craft">
                                        <i class="fa-solid fa-wrench"></i> Craft Req
                                    </button>
                                    <button class="filter-toggle-btn" id="filter-req-barter" data-filter="barter">
                                        <i class="fa-solid fa-right-left"></i> Barter
                                    </button>
                                </div>

                                <div class="w-full overflow-x-auto scrollbar-hide pb-2">
                                    <div class="flex gap-2 min-w-max" id="market-category-filters">
                                        <button class="tarkov-btn active px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="all">Top Value</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="barter">Barter</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="keys">Keys</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="provisions">Food</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="ammo">Ammo</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="mods">Mods</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="container">Container</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="wear">Gear</button>
                                    </div>
                                </div>
                            </div>
                            <div id="market-result-count" class="text-xs text-gray-500 mb-2 text-right">No Data - Loading...</div>
                            <div id="market-grid" class="grid grid-cols-1 gap-3"></div>
                        </div>
                        <div id="subview-crafts" class="hidden" role="tabpanel">
                            <div class="mb-4 space-y-3">
                                <div class="w-full relative">
                                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                    <input type="text" id="craft-search" placeholder="Search Recipe (Reward or Ingredient)..." class="w-full bg-black/40 border border-gray-600 pl-10 pr-4 py-2 rounded text-sm text-white focus:border-tarkov-blue outline-none" aria-label="Search Crafts">
                                </div>

                                <div class="flex flex-wrap gap-2 mb-2">
                                    <button class="filter-toggle-btn" id="filter-craft-req-task" data-filter="task">
                                        <i class="fa-solid fa-scroll"></i> Task Req
                                    </button>
                                    <button class="filter-toggle-btn" id="filter-craft-req-hideout" data-filter="hideout">
                                        <i class="fa-solid fa-hammer"></i> Hideout Req
                                    </button>
                                    <button class="filter-toggle-btn" id="filter-craft-req-craft" data-filter="craft">
                                        <i class="fa-solid fa-wrench"></i> Craft Req
                                    </button>
                                    <button class="filter-toggle-btn" id="filter-craft-req-barter" data-filter="barter">
                                        <i class="fa-solid fa-right-left"></i> Barter
                                    </button>
                                </div>

                                <div class="w-full overflow-x-auto scrollbar-hide pb-2">
                                    <div class="flex gap-2 min-w-max" id="craft-filters">
                                        <button class="tarkov-btn active px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="all">ALL STATIONS</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="ワークベンチ">ワークベンチ</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="洗面所">洗面所</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="医療ステーション">医療ステーション</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="栄養ユニット">栄養ユニット</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="インテリジェンスセンター">インテリジェンス</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="集水器">集水器</button>
                                    </div>
                                </div>
                            </div>
                            <div id="craft-result-count" class="text-xs text-gray-500 mb-2 text-right">No Data - Loading...</div>
                            <div id="crafts-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: TASKS -->
            <div id="view-tasks" class="hidden space-y-4 animate-fade-in">
                <div class="flex flex-col gap-3 mb-4 sticky top-0 bg-tarkov-bg pt-2 pb-4 z-20 border-b border-gray-800">
                    <input type="text" id="task-search" placeholder="タスク名、報酬、詳細で検索..." class="w-full bg-tarkov-panel border border-tarkov-border px-4 py-3 rounded text-sm text-white focus:border-tarkov-accent focus:outline-none shadow-sm" aria-label="Search Tasks">
                    
                    <div class="grid grid-cols-2 gap-2">
                        <select id="filter-trader" class="bg-tarkov-panel border border-tarkov-border px-2 py-2 rounded text-sm text-gray-300">
                            <option value="all">全トレーダー</option>
                        </select>
                         <select id="filter-map" class="bg-tarkov-panel border border-tarkov-border px-2 py-2 rounded text-sm text-gray-300">
                            <option value="all">全マップ</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <select id="filter-type" class="bg-tarkov-panel border border-tarkov-border px-2 py-2 rounded text-sm text-gray-300">
                            <option value="all">全タイプ</option>
                            <option value="kappa">Kappa必須</option>
                            <option value="lightkeeper">Lightkeeper</option>
                        </select>
                        <select id="sort-by" class="bg-tarkov-panel border border-tarkov-border px-2 py-2 rounded text-sm text-gray-300">
                            <option value="minPlayerLevel">レベル順</option>
                            <option value="name">名前順</option>
                            <option value="trader">トレーダー順</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-2 mt-2">
                        <input type="checkbox" id="hide-completed" class="form-checkbox h-4 w-4 text-tarkov-accent rounded border-gray-600 bg-gray-700 focus:ring-tarkov-accent">
                        <label for="hide-completed" class="text-sm text-gray-300">完了済みを非表示</label>
                    </div>
                </div>
                <div id="task-list" class="grid grid-cols-1 gap-3 pb-4">
                    <div class="text-center text-gray-500 py-10">Loading tasks...</div>
                </div>
            </div>

            <!-- VIEW: GUNSMITH -->
            <div id="view-gunsmith" class="hidden space-y-4 animate-fade-in">
                <div class="bg-tarkov-panel border border-tarkov-border p-4 rounded shadow-lg">
                    <h2 class="text-sm font-mono text-tarkov-accent mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-screwdriver-wrench"></i> INTERACTIVE GUNSMITH
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2 space-y-3">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">BASE WEAPON</label>
                                <select id="gs-weapon" class="w-full bg-black border border-gray-600 p-2 text-white font-mono rounded focus:border-tarkov-accent outline-none">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            
                            <div class="bg-black/20 p-3 rounded border border-gray-800 flex flex-col gap-2">
                                <div class="text-[10px] text-tarkov-accent font-bold uppercase tracking-wider flex justify-between items-center">
                                    <span>Target Stats</span>
                                    <button id="gs-disassemble" class="text-red-400 hover:text-red-300 text-[10px] uppercase font-bold flex items-center gap-1">
                                        <i class="fa-solid fa-trash-can"></i> Disassemble
                                    </button>
                                </div>
                                <div class="flex gap-2">
                                    <div class="flex-1">
                                        <input type="number" id="gs-target-ergo" placeholder="Ergo (Target)" class="w-full bg-black border border-gray-600 px-2 py-1 text-xs text-white rounded outline-none focus:border-tarkov-accent">
                                    </div>
                                    <div class="flex-1">
                                        <input type="number" id="gs-target-recoil" placeholder="Recoil (Max)" class="w-full bg-black border border-gray-600 px-2 py-1 text-xs text-white rounded outline-none focus:border-tarkov-accent">
                                    </div>
                                    <button id="gs-auto" class="bg-tarkov-accent text-black px-3 py-1 rounded text-xs font-bold hover:bg-tarkov-accentHover transition flex items-center gap-1">
                                        <i class="fa-solid fa-wand-magic-sparkles"></i> Auto
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="md:col-span-1 grid grid-cols-2 gap-2 text-center content-start">
                            <div class="bg-black/40 p-2 rounded border border-gray-800">
                                <div class="text-[10px] text-gray-500">ERGO</div>
                                <div id="gs-stat-ergo" class="text-xl font-bold text-gray-300">-</div>
                            </div>
                            <div class="bg-black/40 p-2 rounded border border-gray-800">
                                <div class="text-[10px] text-gray-500">RECOIL (V)</div>
                                <div id="gs-stat-recoil" class="text-xl font-bold text-gray-300">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="gs-builder-area" class="space-y-4 min-h-[300px]">
                    <div class="flex flex-col items-center justify-center text-gray-600 opacity-50 py-10">
                        <i class="fa-solid fa-crosshairs text-4xl mb-4"></i>
                        <div class="text-sm font-mono">Select a weapon to begin building</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: HIDEOUT -->
            <div id="view-hideout" class="hidden space-y-4 animate-fade-in">
                <div class="bg-tarkov-panel border border-tarkov-border p-4 rounded shadow-lg sticky top-0 z-20">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-bold text-gray-200"><i class="fa-solid fa-dungeon mr-2 text-tarkov-accent"></i>HIDEOUT STATUS</h2>
                        <span id="hideout-progress-text" class="text-xs text-tarkov-green font-mono">0% Completed</span>
                    </div>
                    <div class="w-full bg-black/50 rounded-full h-2 mb-1 border border-gray-800 overflow-hidden">
                        <div id="hideout-progress-bar" class="bg-tarkov-green h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="text-[10px] text-gray-500 text-right">Next Upgrade: Check items below</div>
                </div>

                <div id="hideout-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 pb-10">
                    <div class="text-center col-span-full py-10 text-gray-500"><span class="loader mr-2"></span>Loading Station Data...</div>
                </div>
            </div>

            <!-- VIEW: AMMO (UPDATED v0.62) -->
            <div id="view-ammo" class="hidden space-y-4 animate-fade-in flex flex-col h-full">
                <!-- Ammo Control Panel -->
                <div class="bg-tarkov-panel p-3 border border-tarkov-border rounded shrink-0 space-y-2">
                    <div class="flex justify-between items-center">
                        <h3 class="text-sm font-bold text-gray-200"><i class="fa-solid fa-bullseye mr-2 text-red-500"></i>BALLISTICS LIVE <span class="text-[10px] text-gray-500 ml-1">v0.62</span></h3>
                        <div class="flex bg-black/40 rounded border border-gray-800 p-0.5">
                            <button id="av-chart" class="px-3 py-1 text-xs rounded transition bg-tarkov-border text-white" onclick="app.switchAmmoView('chart')">CHART</button>
                            <button id="av-list" class="px-3 py-1 text-xs rounded transition text-gray-500 hover:text-white" onclick="app.switchAmmoView('list')">LIST</button>
                        </div>
                    </div>
                    
                    <!-- Filters & Settings -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <select id="ammo-select" class="w-full bg-black/40 border border-gray-600 px-2 py-1.5 rounded text-xs text-white focus:border-tarkov-blue outline-none cursor-pointer">
                            <option value="all">ALL CALIBERS</option>
                        </select>
                        
                        <div class="flex items-center gap-2">
                             <select id="ammo-color-mode" class="flex-1 bg-black/40 border border-gray-600 px-2 py-1.5 rounded text-xs text-white focus:border-tarkov-blue outline-none cursor-pointer">
                                <option value="penetration">Color: Penetration</option>
                                <option value="source">Color: Source (Trader/Flea)</option>
                            </select>
                            <button id="ammo-filter-btn" class="px-3 py-1.5 bg-black/40 border border-gray-600 rounded text-xs text-gray-400 hover:text-white hover:border-gray-400 transition" onclick="app.toggleAmmoFilterPanel()" title="Toggle Filters">
                                <i class="fa-solid fa-filter"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Filter Panel (Collapsible) -->
                    <div id="ammo-filter-panel" class="hidden pt-2 border-t border-gray-800 grid grid-cols-2 gap-2 text-xs text-gray-300">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-white select-none">
                            <input type="checkbox" id="af-hide-unavail" class="form-checkbox h-3 w-3 text-tarkov-accent rounded bg-gray-700 border-gray-600 focus:ring-tarkov-accent">
                            <span>Hide Unavailable</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-white select-none">
                            <input type="checkbox" id="af-trader-only" class="form-checkbox h-3 w-3 text-tarkov-accent rounded bg-gray-700 border-gray-600 focus:ring-tarkov-accent">
                            <span>Trader Only</span>
                        </label>
                    </div>
                </div>

                <!-- Chart Container -->
                <div id="ammo-chart-container" class="glass-panel p-2 rounded flex-1 min-h-[300px] relative">
                    <canvas id="ammoChartCanvas"></canvas>
                </div>

                <!-- List Container -->
                <div id="ammo-list-container" class="glass-panel rounded overflow-hidden flex-1 hidden flex flex-col">
                    <div class="overflow-x-auto flex-1">
                        <table class="w-full text-sm text-left text-gray-400 whitespace-nowrap">
                            <thead class="text-xs text-gray-500 uppercase bg-black/40 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 cursor-pointer hover:text-white group" onclick="app.sortAmmo('name')">Name <i class="fa-solid fa-sort text-[9px] text-gray-600 group-hover:text-gray-400 ml-1"></i></th>
                                    <th class="px-4 py-3 cursor-pointer hover:text-white group" onclick="app.sortAmmo('damage')">Dmg <i class="fa-solid fa-sort text-[9px] text-gray-600 group-hover:text-gray-400 ml-1"></i></th>
                                    <th class="px-4 py-3 cursor-pointer hover:text-white group" onclick="app.sortAmmo('penetration')">Pen <i class="fa-solid fa-sort text-[9px] text-gray-600 group-hover:text-gray-400 ml-1"></i></th>
                                    <th class="px-4 py-3 text-right cursor-pointer hover:text-white group" onclick="app.sortAmmo('price')">Price / Source <i class="fa-solid fa-sort text-[9px] text-gray-600 group-hover:text-gray-400 ml-1"></i></th>
                                </tr>
                            </thead>
                            <tbody id="ammo-table-body" class="divide-y divide-gray-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: LOADOUT (Integrated v0.63) -->
            <div id="view-loadout" class="hidden space-y-4 animate-fade-in">
                <div class="bg-tarkov-panel border border-tarkov-border p-4 rounded shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-gray-200"><i class="fa-solid fa-briefcase-medical mr-2 text-tarkov-purple"></i>TACTICAL INJECTORS</h2>
                        <div class="text-xs text-gray-500">Live Prices & Trader LL Applied</div>
                    </div>
                    
                    <!-- Presets Selection Bar -->
                    <div class="overflow-x-auto scrollbar-hide mb-6 border-b border-gray-800 pb-4">
                         <div class="flex gap-2" id="injector-preset-bar">
                            <!-- Default Presets will be injected here -->
                            <!-- User Presets will be appended here -->
                            <button class="injector-btn rounded p-2 min-w-[100px] text-center border-dashed border-gray-600 hover:border-tarkov-accent flex flex-col items-center justify-center opacity-70 hover:opacity-100" onclick="app.newInjectorPreset()">
                                <i class="fa-solid fa-plus text-gray-400 text-xl mb-1"></i>
                                <span class="text-xs font-bold text-gray-400">CUSTOM</span>
                            </button>
                         </div>
                    </div>

                    <!-- Main Workspace -->
                    <div id="loadout-workspace" class="hidden flex flex-col lg:flex-row gap-6">
                        <!-- Left: Case Visual (3x3 Grid) -->
                        <div class="w-full lg:w-1/3 shrink-0">
                            <div class="bg-[#1a1a1a] p-4 rounded border border-gray-700 shadow-inner relative">
                                <div class="flex justify-between text-[10px] text-gray-500 mb-2 uppercase tracking-widest">
                                    <span>Injector Case</span>
                                    <span>3x3 Grid</span>
                                </div>
                                <div class="grid grid-cols-3 gap-2 aspect-square" id="injector-grid-display">
                                    <!-- Grid Cells Generated by JS -->
                                </div>
                                <div class="mt-2 text-center text-[10px] text-gray-600">Drag & Drop coming soon...</div>
                            </div>
                        </div>
                        
                        <!-- Right: Details & Editor -->
                        <div class="w-full lg:w-2/3 flex flex-col">
                            <!-- Header Info -->
                            <div class="mb-4">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1 mr-4">
                                        <input type="text" id="preset-editor-name" class="bg-transparent border-b border-gray-700 text-xl font-bold text-white w-full focus:border-tarkov-accent outline-none placeholder-gray-600 mb-1" placeholder="Preset Name">
                                        <input type="text" id="preset-editor-desc" class="bg-transparent border-none text-sm text-gray-400 w-full focus:text-gray-200 outline-none placeholder-gray-700" placeholder="Description...">
                                    </div>
                                    <div class="text-right shrink-0">
                                        <div class="text-[10px] text-gray-500 uppercase">Total Cost</div>
                                        <div class="text-2xl font-bold text-tarkov-green font-mono" id="preset-total-cost">₽0</div>
                                    </div>
                                </div>
                                <div id="preset-warning" class="mt-2 hidden p-2 bg-yellow-900/20 border-l-2 border-yellow-600 text-xs text-yellow-500 rounded-r"></div>
                            </div>

                            <!-- Items List / Actions -->
                            <div class="flex-1 bg-black/20 rounded border border-gray-800 flex flex-col overflow-hidden">
                                <div class="px-3 py-2 bg-gray-900/50 border-b border-gray-800 flex justify-between items-center">
                                    <span class="text-xs font-bold text-gray-400 uppercase">Contents & Costs</span>
                                    <button class="text-xs bg-gray-800 hover:bg-gray-700 text-tarkov-accent px-2 py-1 rounded border border-gray-700 transition" onclick="app.showInjectorPicker()">
                                        <i class="fa-solid fa-plus mr-1"></i> Add Injector
                                    </button>
                                </div>
                                <div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1" id="preset-items-list">
                                    <!-- List items injected here -->
                                </div>
                                <div class="p-3 border-t border-gray-800 bg-black/40 flex justify-between items-center">
                                    <button class="text-red-500 hover:text-red-400 text-xs px-3 py-1 rounded hover:bg-red-900/20 transition" id="btn-delete-preset" onclick="app.deleteCurrentPreset()">
                                        <i class="fa-solid fa-trash mr-1"></i> Delete
                                    </button>
                                    <div class="flex gap-2">
                                        <button class="tarkov-btn text-xs px-3 py-1 bg-gray-700 text-gray-300 rounded hover:bg-gray-600 transition" onclick="app.createCustomFromCurrent()">
                                            <i class="fa-solid fa-copy mr-1"></i> Save as New
                                        </button>
                                        <button class="tarkov-btn text-xs px-4 py-1.5 bg-tarkov-accent text-black rounded hover:bg-tarkov-accentHover transition font-bold" id="btn-save-preset" onclick="app.saveCurrentPreset()">
                                            <i class="fa-solid fa-save mr-1"></i> Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="loadout-placeholder" class="text-center py-20 text-gray-500 opacity-50 flex flex-col items-center">
                        <i class="fa-solid fa-box-open text-4xl mb-4"></i>
                        <p>Select a preset above or create a new one</p>
                    </div>
                </div>

                <!-- Injector Picker Modal (Reused) -->
                <div id="injector-picker-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[60] animate-fade-in backdrop-blur-sm">
                    <div class="bg-tarkov-panel border border-tarkov-border p-4 rounded shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 max-h-[80vh] flex flex-col">
                        <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-3">
                            <h3 class="font-bold text-white text-lg"><i class="fa-solid fa-syringe mr-2 text-gray-400"></i>Select Injector</h3>
                            <button class="text-gray-400 hover:text-white" onclick="app.hideInjectorPicker()"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <input type="text" id="injector-picker-search" placeholder="Search (e.g., Propital, SJ6)..." class="w-full bg-black/60 border border-gray-600 px-3 py-3 rounded text-sm text-white focus:border-tarkov-accent outline-none mb-3 shadow-inner">
                        <div id="injector-picker-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-1">
                            <div class="text-gray-500 text-center py-4">Loading injectors...</div>
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>
    
    <!-- Mobile Bottom Navigation -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-[#121212] border-t border-tarkov-border z-[100] pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.5)]">
        <div class="flex justify-around items-stretch h-14">
            <button class="nav-btn-mobile flex-1 flex flex-col items-center justify-center gap-0.5 text-gray-500 mobile-nav-active" data-target="dashboard">
                <i class="fa-solid fa-chart-line text-sm"></i><span class="text-[9px]">Dash</span>
            </button>
            <button class="nav-btn-mobile flex-1 flex flex-col items-center justify-center gap-0.5 text-gray-500" data-target="market">
                <i class="fa-solid fa-shop text-sm"></i><span class="text-[9px]">Market</span>
            </button>
            <button class="nav-btn-mobile flex-1 flex flex-col items-center justify-center gap-0.5 text-gray-500" data-target="wishlist">
                <i class="fa-solid fa-star text-sm"></i><span class="text-[9px]">Wish</span>
            </button>
            <button class="nav-btn-mobile flex-1 flex flex-col items-center justify-center gap-0.5 text-gray-500" data-target="tasks">
                <i class="fa-solid fa-list-check text-sm"></i><span class="text-[9px]">Tasks</span>
            </button>
            <button class="nav-btn-mobile flex-1 flex flex-col items-center justify-center gap-0.5 text-gray-500" data-target="hideout">
                <i class="fa-solid fa-dungeon text-sm"></i><span class="text-[9px]">Hide</span>
            </button>
            <button class="nav-btn-mobile flex-1 flex flex-col items-center justify-center gap-0.5 text-gray-500" data-target="ammo">
                <i class="fa-solid fa-bullseye text-sm"></i><span class="text-[9px]">Chart</span>
            </button>
            <button class="nav-btn-mobile flex-1 flex flex-col items-center justify-center gap-0.5 text-gray-500" data-target="loadout">
                <i class="fa-solid fa-briefcase-medical text-sm"></i><span class="text-[9px]">Loadout</span>
            </button>
        </div>
    </nav>

    <!-- Toast -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-tarkov-panel border border-tarkov-accent text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition duration-300 z-[110] flex items-center gap-3 w-max max-w-[90%] pointer-events-none">
        <i class="fa-solid fa-info-circle text-tarkov-accent"></i><span id="toast-msg" class="text-sm font-medium">Notification</span>
    </div>

    <script>
        // --- APP CONTROLLER ---
        window.app = {
            data: { 
                tasks: [], 
                ammo: [], 
                traders: [],
                maps: [],
                weapons: [], 
                currentBuild: null,
                currentSlotCandidates: [],
                marketItems: [],
                itemPriceMap: new Map(), // Enhanced to allow fallback
                itemFullPriceData: new Map(), // New: Stores detailed BuyFor data
                hideoutMap: new Map(),
                acquisitionMap: new Map(),
                crafts: [],
                craftMap: new Map(),
                hideoutStationsRaw: [],
                userHideoutLevels: {},
                wishlist: new Set(),
                marketConfig: {
                    category: 'all',
                    station: 'all',
                    tab: 'items',
                    filters: { task: false, hideout: false, barter: false, craft: false },
                    craftFilters: { task: false, hideout: false, barter: false, craft: false }
                },
                ammoConfig: {
                    view: 'chart',
                    caliber: 'all',
                    colorMode: 'penetration',
                    filters: { hideUnavailable: false, traderOnly: false },
                    sortBy: 'penetration',
                    sortDesc: true
                },
                config: {
                    gameMode: 'pve', // 'pve' or 'regular'
                    traderLevels: {
                        'Prapor': 4,
                        'Therapist': 4,
                        'Skier': 4,
                        'Peacekeeper': 4,
                        'Mechanic': 4,
                        'Ragman': 4,
                        'Jaeger': 4,
                        'Ref': 4
                    }
                },
                // CACHE FOR AMMO PRICE
                ammoPriceCache: new Map(),
                injectorPresets: [], // Stores user-defined injector presets
                injectorItems: [], // All available injectors/stimulators
            },
            
            // Chart.js Instance
            ammoChart: null,

            consts: {
                typeMapping: { 'barter': ['barter'], 'keys': ['keys'], 'provisions': ['provisions'], 'ammo': ['ammo'], 'mods': ['mods', 'suppressor'], 'container': ['container'], 'wear': ['armor', 'helmet', 'glasses', 'headphones', 'rig', 'backpack'] },
                globalTypes: ['barter', 'keys', 'ammo', 'provisions', 'mods', 'suppressor', 'container', 'armor', 'helmet', 'glasses', 'headphones', 'rig', 'backpack', 'gun', 'meds'],
                tradersList: ['Prapor', 'Therapist', 'Skier', 'Peacekeeper', 'Mechanic', 'Ragman', 'Jaeger', 'Ref'],
                sherpaIntelDB: {
                    "Delivery from the Past": {
                        desc: "Factoryは夜間推奨。Customsで回収後、一度スタッシュに戻りクエスト倉庫にアイテムを移すこと。",
                        tips: ["夜間Factoryは懐中電灯を持参", "Praporsの手紙は脱出不要"]
                    }
                },
                injectorLoadouts: {
                    "boss": {
                        title: "💀 COMBAT (Boss/PvP)",
                        desc: "ボス討伐・急な接敵用。出血・骨折・HP減少に即座に対応。",
                        warning: "水分・エネルギー消費に注意。",
                        items: ["Propital", "eTG-change", "Zagustin"]
                    },
                    "marathon": {
                        title: "🏃 MARATHON (Rotation)",
                        desc: "長距離移動用。スタミナ回復と上限をブースト。",
                        warning: "SJ6とTrimadolは重複可能。",
                        items: ["SJ6 TGLabs", "Trimadol", "L1"]
                    },
                    "loot": {
                        title: "🎒 HEAVY LOOT (MULE)",
                        desc: "重量制限無視。戦車バッテリーや重装備回収用。",
                        warning: "M.U.L.E.使用中は被ダメージ+9%。",
                        items: ["M.U.L.E.", "SJ6 TGLabs", "Propital"]
                    },
                    "budget": {
                        title: "💰 BUDGET (Standard)",
                        desc: "タスク・普段使い用。最低限の鎮痛とリジェネ。",
                        warning: "コストパフォーマンス優先。",
                        items: ["Propital", "Morphine"]
                    },
                    "night": {
                        title: "🌙 NIGHT (Scav Hunt)",
                        desc: "夜間用。知覚強化と体温低下(サーマル対策)。",
                        warning: "SJ12は餓死防止にも有効。",
                        items: ["SJ12 TGLabs", "SJ1 TGLabs"]
                    }
                }
            },
            
            // --- UTIL: Debounce ---
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func.apply(this, args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            async init() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.runInit());
                } else {
                    this.runInit();
                }
            },

            async runInit() {
                this.loadConfig(); 
                this.renderConfigUI();
                this.setupListeners();
                this.loadHideoutStatus();
                this.loadWishlist();
                this.safeUpdateText('market-result-count', "Waiting for Sync...");
                this.fetchLiveStats();
                this.fetchWeaponData();
            },

            async fetchApiData(query) {
                try {
                    const cleanQuery = query.replace(new RegExp("[\\r\\n]+", "g"), ' ').replace(new RegExp("\\s{2,}", "g"), ' ').trim();
                    const res = await fetch('https://api.tarkov.dev/graphql', {
                        method: 'POST', 
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Accept': 'application/json' 
                        }, 
                        body: JSON.stringify({ query: cleanQuery })
                    });
                    
                    if (!res.ok) throw new Error(`HTTP Status ${res.status}`);
                    const json = await res.json();
                    if (json.errors) {
                        console.error("API Errors:", json.errors);
                        if(!json.data) throw new Error(json.errors[0].message);
                    }
                    if (json.data) return json.data;
                    throw new Error("No data in response");
                } catch (e) {
                    console.error("API Fetch Error:", e);
                    this.showToast("Connection Error: " + e.message);
                    this.safeUpdateHTML('dash-status', `<span class="text-red-500">ERROR</span>`);
                    return null;
                }
            },

            async fetchLiveStats() {
                const btn = document.getElementById('sync-btn');
                const original = btn ? btn.innerHTML : '';
                if(btn) {
                    btn.innerHTML = `<span class="loader"></span>`;
                    btn.disabled = true;
                }

                const modeLabel = this.data.config.gameMode === 'pve' ? 'PvE Zone' : 'PvP Mode';
                const modeColor = this.data.config.gameMode === 'pve' ? 'bg-tarkov-green text-black' : 'bg-red-600 text-white';
                const badge = document.getElementById('header-mode-badge');
                if(badge) {
                    badge.className = `text-[10px] px-1 rounded ml-1 align-top transition-colors ${modeColor}`;
                    badge.innerText = this.data.config.gameMode === 'pve' ? 'PvE' : 'PvP';
                }

                this.showToast(`Syncing Data (${modeLabel})...`);
                this.safeUpdateHTML('dash-status', `<span class="text-yellow-500">INITIALIZING...</span>`);

                try {
                    const taskQuery = `{ 
                        tasks(limit: 1000, lang: ja) { 
                            id name minPlayerLevel kappaRequired map { name } trader { name } wikiLink lightkeeperRequired
                            objectives { description } 
                            startRewards { traderStanding { trader { name } standing } items { item { name shortName gridImageLink } count } } 
                            finishRewards { traderStanding { trader { name } standing } items { item { name shortName gridImageLink } count } }
                        }
                        ammo(limit: 200, lang: en) { item { id name shortName } caliber damage penetrationPower armorDamage }
                    }`;
                    
                    const taskData = await this.fetchApiData(taskQuery);
                    if (taskData) {
                        this.loadTaskCompletionStatus();
                        const savedStatus = JSON.parse(localStorage.getItem('taskCompletionStatus') || '{}');
                        
                        this.data.tasks = taskData.tasks.map(t => ({...t, completed: !!savedStatus[t.id]}));
                        this.data.ammo = taskData.ammo.sort((a, b) => b.penetrationPower - a.penetrationPower);
                        this.processTaskMetaData();
                        this.renderTasks();
                        // Delay initial ammo render until market data is available for prices
                        this.safeUpdateText('dash-task-count', this.data.tasks.length);
                    }

                    await this.fetchMarketDataFull();
                    
                    // Now that we have prices, bind them to ammo and render
                    this.bindAmmoPrices();
                    this.renderAmmo();
                    this.loadInjectorPresets();

                    this.safeUpdateHTML('dash-status', `<span class="${this.data.config.gameMode === 'pve' ? 'text-green-400' : 'text-red-400'}">ONLINE (${this.data.config.gameMode === 'pve' ? 'PvE' : 'PvP'})</span>`);
                    this.showToast("System Fully Synchronized");

                } catch (e) {
                    console.error(e);
                    this.showToast("Partial Sync Fail");
                    this.safeUpdateHTML('dash-status', `<span class="text-red-500">SYNC ERROR</span>`);
                }
                
                if(btn) {
                    btn.innerHTML = original;
                    btn.disabled = false;
                }
            },

            async fetchMarketDataFull() {
                const gameMode = this.data.config.gameMode;
                
                const hideoutQuery = `{ hideoutStations(lang: ja) { id name levels { level itemRequirements { count item { id name iconLink } } } } }`;
                const hideoutData = await this.fetchApiData(hideoutQuery);
                if (hideoutData) {
                    this.data.hideoutStationsRaw = hideoutData.hideoutStations;
                    this.data.hideoutMap.clear();
                    hideoutData.hideoutStations.forEach(s => s.levels.forEach(l => l.itemRequirements.forEach(r => {
                        if (!this.data.hideoutMap.has(r.item.id)) this.data.hideoutMap.set(r.item.id, []);
                        this.data.hideoutMap.get(r.item.id).push({ stationId: s.id, stationName: s.name, level: l.level, count: r.count });
                    })));
                    this.renderHideout();
                }

                const barterQuery = `{ barters(lang: ja) { trader { name } level requiredItems { count item { name iconLink } } rewardItems { item { id } } } }`;
                const barterData = await this.fetchApiData(barterQuery);
                if (barterData) {
                    this.data.acquisitionMap.clear();
                    barterData.barters.forEach(b => b.rewardItems.forEach(r => {
                        if (!this.data.acquisitionMap.has(r.item.id)) this.data.acquisitionMap.set(r.item.id, []);
                        this.data.acquisitionMap.get(r.item.id).push({ traderName: b.trader.name, level: b.level, ingredients: b.requiredItems });
                    }));
                }

                const marketQuery = `{ 
                    items(gameMode: ${gameMode}, limit: 3500, offset: 0, types: [${this.consts.globalTypes.join(', ')}], lang: ja) {
                        id name shortName avg24hPrice low24hPrice high24hPrice changeLast48hPercent wikiLink types iconLink gridImageLink description
                        sellFor { price source } 
                        buyFor { price source vendor { name } requirements { type value } }
                        usedInTasks { id name trader { name } wikiLink }
                        bartersFor { trader { name } level rewardItems { item { name } } }
                    }
                }`;
                const marketRes = await this.fetchApiData(marketQuery);
                if (marketRes) {
                    this.data.marketItems = marketRes.items.filter(i => i.avg24hPrice > 0 || (i.buyFor && i.buyFor.length > 0)).sort((a, b) => b.avg24hPrice - a.avg24hPrice);
                    this.data.itemPriceMap.clear();
                    this.data.itemFullPriceData.clear(); 

                    this.data.marketItems.forEach(i => {
                        this.data.itemFullPriceData.set(i.id, {
                            avg24hPrice: i.avg24hPrice,
                            buyFor: i.buyFor || []
                        });
                        this.data.itemPriceMap.set(i.id, i.avg24hPrice);
                    });
                    
                    // Populate Injector/Meds Items for Loadout Manager
                    this.data.injectorItems = this.data.marketItems
                        .filter(i => i.types.includes('meds'))
                        .map(i => {
                            const bestPrice = this.getBestPrice(i.id);
                            return { ...i, priceData: bestPrice };
                        })
                        .sort((a,b) => a.name.localeCompare(b.name));
                    
                    // --- DEBUG START: Log specific injector item names ---
                    const debugItemNames = ["eTG-change", "SJ6 TGLabs", "SJ12 TGLabs", "SJ1 TGLabs"];
                    console.log("--- Debugging Injector Names ---");
                    debugItemNames.forEach(debugName => {
                        const foundItem = this.data.injectorItems.find(i => 
                            i.name.includes(debugName) || (i.shortName && i.shortName.includes(debugName))
                        );
                        if (foundItem) {
                            console.log(`Found "${debugName}": Name - "${foundItem.name}", ShortName - "${foundItem.shortName}", ID - "${foundItem.id}", Icon - "${foundItem.iconLink}"`);
                        } else {
                            console.log(`"${debugName}" not found in injectorItems.`);
                            // Attempt to find similar names
                            const potentialMatches = this.data.injectorItems.filter(i => 
                                (i.name && i.name.toLowerCase().includes(debugName.split(' ')[0].toLowerCase())) || 
                                (i.shortName && i.shortName.toLowerCase().includes(debugName.split(' ')[0].toLowerCase())) ||
                                (i.name && i.name.toLowerCase().includes('stimulant')) || 
                                (i.name && i.name.toLowerCase().includes('injector'))
                            ).slice(0,5); // Limit to 5 potential matches
                            if(potentialMatches.length > 0) {
                                console.log(`  Potential matches for "${debugName}":`);
                                potentialMatches.forEach(pm => console.log(`    - Name: "${pm.name}", ShortName: "${pm.shortName}", ID: "${pm.id}"`));
                            }
                        }
                    });
                    console.log("-------------------------------");
                    // --- DEBUG END ---

                    this.safeUpdateText('dash-market-count', this.data.marketItems.length);
                }

                const craftQuery = `{ 
                    crafts(lang: ja) {
                        station { name } level duration
                        requiredItems { count item { id name iconLink } }
                        rewardItems { count item { id name iconLink } }
                    }
                }`;
                const craftRes = await this.fetchApiData(craftQuery);
                if (craftRes) {
                    this.data.craftMap.clear();
                    this.data.crafts = craftRes.crafts.map(c => {
                        const cost = c.requiredItems.reduce((acc, req) => {
                            const bestPrice = this.getBestPrice(req.item.id);
                            return acc + (bestPrice.price * req.count);
                        }, 0);
                        const rev = c.rewardItems.reduce((a, r) => a + ((this.data.itemPriceMap.get(r.item.id) || 0) * r.count), 0);
                        const profit = (rev * 0.9) - cost;
                        c.requiredItems.forEach(req => {
                            if(!this.data.craftMap.has(req.item.id)) this.data.craftMap.set(req.item.id, []);
                            this.data.craftMap.get(req.item.id).push({ type: 'ingredient', profit, station: c.station.name, level: c.level, products: c.rewardItems });
                        });
                        return { ...c, cost, profit };
                    }).sort((a, b) => b.profit - a.profit);
                }
                
                this.calculateAllRequirements();
                this.renderMarket();
                this.renderCrafts();
                this.renderWishlist();
            },
            
            getBestPrice(itemId) {
                const data = this.data.itemFullPriceData.get(itemId);
                if (!data) return { price: 0, source: 'unknown', vendor: 'Unknown' };

                let bestPrice = 999999999;
                let source = 'unknown';
                let vendor = 'Unavailable';

                // Check Flea
                if (data.avg24hPrice > 0) {
                    bestPrice = data.avg24hPrice;
                    source = 'flea';
                    vendor = 'Flea Market';
                }

                // Check Traders
                if (data.buyFor) {
                    data.buyFor.forEach(offer => {
                        if (offer.source === 'fleaMarket') return; 
                        
                        const traderName = offer.vendor.name;
                        const userLL = this.data.config.traderLevels[traderName] || 4; 
                        
                        const llReq = offer.requirements.find(r => r.type === 'loyaltyLevel');
                        const reqLevel = llReq ? llReq.value : 1;

                        if (userLL >= reqLevel) {
                            if (offer.price < bestPrice) {
                                bestPrice = offer.price;
                                source = 'trader';
                                vendor = `${traderName} LL${reqLevel}`;
                            }
                        }
                    });
                }
                
                // FIXED: If price is still infinity, it means no source found. Reset to 0.
                if (bestPrice === 999999999) {
                    bestPrice = 0;
                    source = 'unknown';
                    vendor = 'Unavailable';
                }

                return { price: bestPrice, source, vendor };
            },

            // --- V0.61 SAFE DATA BINDING ---
            bindAmmoPrices() {
                this.data.ammo.forEach(a => {
                    // Try exact ID match first
                    let priceInfo = this.getBestPrice(a.item.id);
                    
                    // Fallback: Name Match if ID fails or price is 0 (API inconsistency safeguard)
                    if (priceInfo.price === 0 || priceInfo.source === 'unknown') {
                        const match = this.data.marketItems.find(mi => mi.name === a.item.name || mi.shortName === a.item.shortName);
                        if (match) {
                            priceInfo = this.getBestPrice(match.id);
                        }
                    }
                    
                    a.priceData = priceInfo;
                });
            },

            calculateAllRequirements() {
                this.data.marketItems.forEach(item => {
                    item.reqData = { 
                        total: { task: 0, hideout: 0 },
                        remaining: { task: 0, hideout: 0 },
                        active: false
                    };
                    if(item.usedInTasks) {
                        item.usedInTasks.forEach(t => {
                            const taskInfo = this.data.tasks.find(tk => tk.id === t.id);
                            const count = 1; 
                            item.reqData.total.task += count;
                            if(taskInfo && !taskInfo.completed) {
                                item.reqData.remaining.task += count;
                            }
                        });
                    }
                    const hReqs = this.data.hideoutMap.get(item.id);
                    if(hReqs) {
                        hReqs.forEach(h => {
                            item.reqData.total.hideout += h.count;
                            const curLvl = this.data.userHideoutLevels[h.stationId] || 0;
                            if(h.level > curLvl) {
                                item.reqData.remaining.hideout += h.count;
                            }
                        });
                    }
                    if(item.reqData.remaining.task > 0 || item.reqData.remaining.hideout > 0) {
                        item.reqData.active = true;
                    }
                });
            },

            // --- CONFIG MODULE ---
            loadConfig() {
                const saved = localStorage.getItem('eft_sherpa_config');
                if(saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        this.data.config = { ...this.data.config, ...parsed };
                    } catch(e) { console.error("Config Load Error", e); }
                }
            },
            saveConfig() {
                localStorage.setItem('eft_sherpa_config', JSON.stringify(this.data.config));
            },
            updateGameMode(mode) {
                if(this.data.config.gameMode === mode) return;
                this.data.config.gameMode = mode;
                this.saveConfig();
                this.fetchLiveStats();
            },
            updateTraderLevel(trader, level) {
                this.data.config.traderLevels[trader] = parseInt(level);
                this.saveConfig();
                this.recalcCrafts();
                this.renderMarket(); 
                this.renderCrafts();
                // New: Re-bind ammo prices when LL changes
                this.bindAmmoPrices();
                this.renderAmmo();
            },
            
            recalcCrafts() {
                this.data.crafts = this.data.crafts.map(c => {
                    const cost = c.requiredItems.reduce((acc, req) => {
                        const bestPrice = this.getBestPrice(req.item.id);
                        return acc + (bestPrice.price * req.count);
                    }, 0);
                    const rev = c.rewardItems.reduce((a, r) => a + ((this.data.itemPriceMap.get(r.item.id) || 0) * r.count), 0);
                    const profit = (rev * 0.9) - cost;
                    return { ...c, cost, profit };
                }).sort((a, b) => b.profit - a.profit);
            },

            renderConfigUI() {
                const radioPve = document.querySelector(`input[name="gameMode"][value="pve"]`);
                const radioReg = document.querySelector(`input[name="gameMode"][value="regular"]`);
                if(radioPve) radioPve.checked = this.data.config.gameMode === 'pve';
                if(radioReg) radioReg.checked = this.data.config.gameMode === 'regular';

                const container = document.getElementById('settings-trader-grid');
                if(container) {
                    container.innerHTML = this.consts.tradersList.map(t => {
                        const lvl = this.data.config.traderLevels[t] || 4;
                        return `
                        <div class="bg-black/40 p-2 rounded border border-gray-700 flex flex-col gap-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-gray-300">${t}</span>
                                <span class="text-xs text-tarkov-accent font-mono">LL${lvl}</span>
                            </div>
                            <div class="trader-level-selector">
                                <select onchange="app.updateTraderLevel('${t}', this.value)" class="w-full bg-black border border-gray-600 rounded text-xs py-1 text-white focus:border-tarkov-accent">
                                    <option value="1" ${lvl==1?'selected':''}>Level 1</option>
                                    <option value="2" ${lvl==2?'selected':''}>Level 2</option>
                                    <option value="3" ${lvl==3?'selected':''}>Level 3</option>
                                    <option value="4" ${lvl==4?'selected':''}>Level 4 (MAX)</option>
                                </select>
                            </div>
                        </div>`;
                    }).join('');
                }
            },

            // --- HELPER FUNCTIONS ---
            safeUpdateText(id, value) { const el = document.getElementById(id); if (el) el.innerText = value; },
            safeUpdateHTML(id, html) { const el = document.getElementById(id); if (el) el.innerHTML = html; },

            switchMarketTab(tab) {
                this.data.marketConfig.tab = tab;
                const tabItems = document.getElementById('mt-items');
                const tabCrafts = document.getElementById('mt-crafts');
                if(tabItems) {
                    tabItems.className = `market-nav-tab ${tab === 'items' ? 'active' : ''}`;
                    tabItems.setAttribute('aria-selected', tab === 'items');
                }
                if(tabCrafts) {
                    tabCrafts.className = `market-nav-tab ${tab === 'crafts' ? 'active' : ''}`;
                    tabCrafts.setAttribute('aria-selected', tab === 'crafts');
                }
                const viewItems = document.getElementById('subview-items');
                if(viewItems) viewItems.classList.toggle('hidden', tab !== 'items');
                const viewCrafts = document.getElementById('subview-crafts');
                if(viewCrafts) viewCrafts.classList.toggle('hidden', tab !== 'crafts');
            },

            toggleMarketFilter(type) {
                this.data.marketConfig.filters[type] = !this.data.marketConfig.filters[type];
                const btn = document.getElementById(`filter-req-${type}`);
                if(btn) btn.classList.toggle('active', this.data.marketConfig.filters[type]);
                this.renderMarket();
            },

            toggleCraftFilter(type) {
                this.data.marketConfig.craftFilters[type] = !this.data.marketConfig.craftFilters[type];
                const btn = document.getElementById(`filter-craft-req-${type}`);
                if(btn) btn.classList.toggle('active', this.data.marketConfig.craftFilters[type]);
                this.renderCrafts();
            },

            loadWishlist() { const s = localStorage.getItem('userWishlist'); if (s) this.data.wishlist = new Set(JSON.parse(s)); },
            saveWishlist() { localStorage.setItem('userWishlist', JSON.stringify([...this.data.wishlist])); },
            toggleWishlist(id) {
                if (this.data.wishlist.has(id)) this.data.wishlist.delete(id);
                else this.data.wishlist.add(id);
                this.saveWishlist();
                this.renderMarket();
                this.renderWishlist();
            },

            // --- AMMO VIEWER FUNCTIONS (Refactored v0.62) ---
            switchAmmoView(view) {
                this.data.ammoConfig.view = view;
                const btnChart = document.getElementById('av-chart');
                const btnList = document.getElementById('av-list');
                if(btnChart) btnChart.className = `px-3 py-1 text-xs rounded transition ${view === 'chart' ? 'bg-tarkov-border text-white' : 'text-gray-500 hover:text-white'}`;
                if(btnList) btnList.className = `px-3 py-1 text-xs rounded transition ${view === 'list' ? 'bg-tarkov-border text-white' : 'text-gray-500 hover:text-white'}`;
                
                const cContainer = document.getElementById('ammo-chart-container');
                if(cContainer) cContainer.classList.toggle('hidden', view !== 'chart');
                const lContainer = document.getElementById('ammo-list-container');
                if(lContainer) lContainer.classList.toggle('hidden', view !== 'list');
            },
            
            toggleAmmoFilterPanel() {
                const p = document.getElementById('ammo-filter-panel');
                if(p) p.classList.toggle('hidden');
            },

            renderAmmo() {
                if (!this.data.ammo || this.data.ammo.length === 0) return;
                const calibers = [...new Set(this.data.ammo.map(a => a.caliber))].sort();
                const select = document.getElementById('ammo-select');
                if (select && select.children.length <= 1) {
                     calibers.forEach(cal => {
                        const cleanCal = cal.replace('Caliber', '');
                        const opt = document.createElement('option');
                        opt.value = cal;
                        opt.innerText = cleanCal;
                        select.appendChild(opt);
                    });
                }
                this.updateAmmoVisuals();
            },

            sortAmmo(key) {
                const conf = this.data.ammoConfig;
                if(conf.sortBy === key) conf.sortDesc = !conf.sortDesc;
                else { conf.sortBy = key; conf.sortDesc = true; }
                this.updateAmmoVisuals();
            },

            getFilteredAmmoData() {
                const conf = this.data.ammoConfig;
                let data = this.data.ammo.map(a => {
                    const pd = a.priceData || { price: 0, source: 'unknown' };
                    // Determine availability status for filters
                    const isUnavailable = pd.source === 'unknown' || pd.price === 0;
                    const isTrader = pd.source === 'trader';
                    return { ...a, isUnavailable, isTrader };
                });

                // 1. Caliber Filter
                if (conf.caliber !== 'all') data = data.filter(a => a.caliber === conf.caliber);

                // 2. Availability Filters
                if (conf.filters.hideUnavailable) data = data.filter(a => !a.isUnavailable);
                if (conf.filters.traderOnly) data = data.filter(a => a.isTrader);

                // 3. Sort (Only for List View primarily, but good for consistency)
                data.sort((a, b) => {
                    let valA, valB;
                    switch(conf.sortBy) {
                        case 'name': valA = a.item.name; valB = b.item.name; break;
                        case 'damage': valA = a.damage; valB = b.damage; break;
                        case 'price': valA = (a.priceData?.price || 0); valB = (b.priceData?.price || 0); break;
                        default: valA = a.penetrationPower; valB = b.penetrationPower; // penetration
                    }
                    if(typeof valA === 'string') return conf.sortDesc ? valB.localeCompare(valA) : valA.localeCompare(valB);
                    return conf.sortDesc ? valB - valA : valA - valB;
                });
                
                return data;
            },

            updateAmmoVisuals() {
                const filteredData = this.getFilteredAmmoData();
                this.renderAmmoList(filteredData);
                this.renderAmmoChart(filteredData);
            },

            renderAmmoList(data) {
                const tbody = document.getElementById('ammo-table-body');
                if(!tbody) return;
                tbody.innerHTML = data.map(a => {
                    const pd = a.priceData || { price: 0, source: 'unknown', vendor: 'Unavailable' };
                    const priceDisplay = pd.price > 0 ? `₽${pd.price.toLocaleString()}` : '<span class="text-gray-600 font-normal">N/A</span>';
                    const sourceDisplay = pd.source === 'trader' ? `<span class="text-tarkov-green">${pd.vendor}</span>` : (pd.source === 'flea' ? '<span class="text-blue-400">Flea</span>' : '<span class="text-red-900">Unavailable</span>');
                    
                    return `
                    <tr class="hover:bg-white/5 border-b border-gray-800">
                        <td class="px-4 py-3 font-mono text-xs text-gray-300">
                            <span class="text-tarkov-accent font-bold">${a.item.shortName || a.item.name}</span><br>
                            <span class="text-[9px] text-gray-500">${a.caliber.replace('Caliber','')}
                        </td>
                        <td class="px-4 py-3 text-gray-400 font-mono">${a.damage}</td>
                        <td class="px-4 py-3 font-bold font-mono ${a.penetrationPower > 40 ? 'text-red-400' : (a.penetrationPower > 30 ? 'text-yellow-500' : 'text-gray-500')}">${a.penetrationPower}</td>
                        <td class="px-4 py-3 text-xs font-mono text-right">
                            <div class="font-bold text-white">${priceDisplay}</div>
                            <div class="text-[9px]">${sourceDisplay}</div>
                        </td>
                    </tr>
                `}).join('');
            },

            renderAmmoChart(data) {
                const ctx = document.getElementById('ammoChartCanvas');
                if (!ctx) return;
                if (this.ammoChart) this.ammoChart.destroy();

                const mode = this.data.ammoConfig.colorMode; // 'penetration' or 'source'

                const scatterData = data.map(a => ({
                    x: a.damage,
                    y: a.penetrationPower,
                    name: a.item.shortName || a.item.name,
                    priceData: a.priceData,
                    fullData: a
                }));

                const getColor = (d) => {
                    if (mode === 'source') {
                        const src = d.priceData?.source;
                        if (src === 'trader') return '#4ade80'; // Green
                        if (src === 'flea') return '#60a5fa'; // Blue
                        return '#374151'; // Dark Grey (Unavailable)
                    } else {
                        // Penetration Mode
                        const pen = d.y;
                        if (pen >= 60) return '#ef4444'; 
                        if (pen >= 50) return '#f97316'; 
                        if (pen >= 40) return '#eab308'; 
                        if (pen >= 30) return '#84cc16'; 
                        return '#6b7280'; 
                    }
                };

                const backgroundColors = scatterData.map(d => getColor(d));
                const pointRadii = scatterData.map(d => (mode === 'source' && d.priceData?.source === 'unknown') ? 4 : 6); // Make unavailable dots smaller in source mode

                this.ammoChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Ammo Performance',
                            data: scatterData,
                            backgroundColor: backgroundColors,
                            pointRadius: pointRadii,
                            pointHoverRadius: 10,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(10, 10, 10, 0.95)',
                                titleColor: '#9a8c7d',
                                bodyColor: '#fff',
                                borderColor: '#333',
                                borderWidth: 1,
                                padding: 10,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        const p = context.raw;
                                        const pd = p.priceData || { price: 0, vendor: 'Unknown' };
                                        const priceText = pd.price > 0 ? `₽${pd.price.toLocaleString()}` : 'N/A';
                                        
                                        return [
                                            `[${p.name}]`,
                                            `Pen: ${p.y}  /  Dmg: ${p.x}`,
                                            `----------------`,
                                            `Vendor: ${pd.vendor}`,
                                            `Price: ${priceText}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'DAMAGE', color: '#666' },
                                grid: { color: '#333' },
                                ticks: { color: '#888' }
                            },
                            y: {
                                title: { display: true, text: 'PENETRATION', color: '#666' },
                                grid: { color: '#333' },
                                ticks: { color: '#888' },
                                min: 0,
                                max: 80
                            }
                        }
                    }
                });
            },

            // --- LOADOUT MANAGER (Integrated v0.63) ---
            currentEditingPreset: null, 

            async loadInjectorPresets() {
                const s = localStorage.getItem('injectorPresets');
                if (s) {
                    try { this.data.injectorPresets = JSON.parse(s); } 
                    catch (e) { console.error("Loadout Load Error", e); this.data.injectorPresets = []; }
                }
                this.renderPresetBar();
            },

            saveInjectorPresets() {
                localStorage.setItem('injectorPresets', JSON.stringify(this.data.injectorPresets));
                this.renderPresetBar();
            },

            // --- Preset Selection & Bar Rendering ---
            renderPresetBar() {
                const bar = document.getElementById('injector-preset-bar');
                if (!bar) return;

                // Keep the "Custom" button at the end
                const customBtn = bar.lastElementChild;
                bar.innerHTML = '';

                // 1. Default Presets
                Object.keys(this.consts.injectorLoadouts).forEach(key => {
                    const def = this.consts.injectorLoadouts[key];
                    const btn = document.createElement('button');
                    btn.className = `injector-btn rounded p-2 min-w-[100px] text-center shrink-0 flex flex-col items-center justify-center gap-1 bg-[#111] ${this.currentEditingPreset?.id === key ? 'active' : ''}`;
                    btn.onclick = () => this.selectPreset(key, true);
                    
                    // Icon mapping based on key
                    let icon = 'fa-syringe';
                    if(key === 'boss') icon = 'fa-skull text-red-500';
                    else if(key === 'marathon') icon = 'fa-person-running text-blue-400';
                    else if(key === 'loot') icon = 'fa-weight-hanging text-yellow-500';
                    else if(key === 'budget') icon = 'fa-piggy-bank text-green-400';
                    else if(key === 'night') icon = 'fa-moon text-purple-400';

                    btn.innerHTML = `<i class="fa-solid ${icon} text-xl"></i><span class="text-[10px] font-bold text-gray-300 uppercase">${key}</span>`;
                    bar.appendChild(btn);
                });

                // Separator
                const sep = document.createElement('div');
                sep.className = "w-px bg-gray-700 mx-1 shrink-0";
                bar.appendChild(sep);

                // 2. User Presets
                this.data.injectorPresets.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = `injector-btn rounded p-2 min-w-[100px] text-center shrink-0 flex flex-col items-center justify-center gap-1 bg-[#111] border-dashed border-gray-600 ${this.currentEditingPreset?.id === p.id ? 'active' : ''}`;
                    btn.onclick = () => this.selectPreset(p.id, false);
                    btn.innerHTML = `<i class="fa-solid fa-user-astronaut text-gray-400 text-xl"></i><span class="text-[10px] font-bold text-gray-300 truncate max-w-[80px]">${p.name}</span>`;
                    bar.appendChild(btn);
                });

                bar.appendChild(customBtn);
            },

            selectPreset(id, isDefault) {
                if (isDefault) {
                    const def = this.consts.injectorLoadouts[id];
                    this.currentEditingPreset = {
                        id: id,
                        name: def.title,
                        description: def.desc,
                        warning: def.warning,
                        isDefault: true,
                        injectors: def.items.map(name => {
                            const item = this.data.injectorItems.find(i => i.name.includes(name) || (i.shortName && i.shortName.includes(name)));
                            const icon = item?.iconLink || 'https://via.placeholder.com/40x40?text=NO+IMG'; 
                            const itemId = item?.id || null;
                            const shortName = item?.shortName || name;
                            const priceData = item ? this.getBestPrice(item.id) : { price: 0, source: 'unknown', vendor: 'Unknown' };

                            return { id: itemId, name: name, shortName: shortName, iconLink: icon, priceData: priceData };
                        })
                    };
                } else {
                    const userP = this.data.injectorPresets.find(p => p.id === id);
                    if(userP) {
                        this.currentEditingPreset = JSON.parse(JSON.stringify(userP));
                        this.currentEditingPreset.isDefault = false;
                        this.currentEditingPreset.injectors.forEach(inj => {
                            if(inj.id) {
                                const item = this.data.injectorItems.find(i => i.id === inj.id);
                                inj.iconLink = item?.iconLink || 'https://via.placeholder.com/40x40?text=NO+IMG';
                                inj.priceData = this.getBestPrice(inj.id);
                            } else {
                                inj.iconLink = 'https://via.placeholder.com/40x40?text=NO+IMG';
                                inj.priceData = { price: 0, source: 'unknown', vendor: 'Unknown' };
                            }
                        });
                    }
                }

                this.renderLoadoutWorkspace();
                this.renderPresetBar();
            },

            newInjectorPreset() {
                this.currentEditingPreset = {
                    id: Date.now().toString(),
                    name: 'New Preset',
                    description: '',
                    injectors: [],
                    isDefault: false
                };
                this.renderLoadoutWorkspace();
                this.renderPresetBar();
            },

            createCustomFromCurrent() {
                if(!this.currentEditingPreset) return;
                const newPreset = JSON.parse(JSON.stringify(this.currentEditingPreset));
                newPreset.id = Date.now().toString();
                newPreset.name = `Copy of ${newPreset.name}`;
                newPreset.isDefault = false;
                delete newPreset.warning; 
                
                this.data.injectorPresets.push(newPreset);
                this.saveInjectorPresets();
                this.selectPreset(newPreset.id, false);
                this.showToast("Preset copied! You can now edit it.");
            },

            saveCurrentPreset() {
                if (!this.currentEditingPreset || this.currentEditingPreset.isDefault) return;
                
                const nameInput = document.getElementById('preset-editor-name');
                const descInput = document.getElementById('preset-editor-desc');
                
                this.currentEditingPreset.name = nameInput.value || "Untitled";
                this.currentEditingPreset.description = descInput.value || "";

                const idx = this.data.injectorPresets.findIndex(p => p.id === this.currentEditingPreset.id);
                if (idx > -1) this.data.injectorPresets[idx] = this.currentEditingPreset;
                else this.data.injectorPresets.push(this.currentEditingPreset);

                this.saveInjectorPresets();
                this.showToast("Preset saved successfully.");
            },

            deleteCurrentPreset() {
                if (!this.currentEditingPreset || this.currentEditingPreset.isDefault) return;
                if (!confirm("Delete this preset?")) return;

                this.data.injectorPresets = this.data.injectorPresets.filter(p => p.id !== this.currentEditingPreset.id);
                this.saveInjectorPresets();
                this.currentEditingPreset = null;
                this.renderLoadoutWorkspace();
                this.showToast("Preset deleted.");
            },

            // --- Workspace Rendering ---
            renderLoadoutWorkspace() {
                const ws = document.getElementById('loadout-workspace');
                const ph = document.getElementById('loadout-placeholder');
                
                if (!this.currentEditingPreset) {
                    ws.classList.add('hidden');
                    ph.classList.remove('hidden');
                    return;
                }

                ws.classList.remove('hidden');
                ph.classList.add('hidden');

                // Header
                const nameInp = document.getElementById('preset-editor-name');
                const descInp = document.getElementById('preset-editor-desc');
                const warningBox = document.getElementById('preset-warning');
                const btnSave = document.getElementById('btn-save-preset');
                const btnDelete = document.getElementById('btn-delete-preset');

                nameInp.value = this.currentEditingPreset.name;
                descInp.value = this.currentEditingPreset.description || '';
                
                // Read-only mode for defaults
                const isDef = this.currentEditingPreset.isDefault;
                nameInp.disabled = isDef;
                descInp.disabled = isDef;
                btnSave.style.display = isDef ? 'none' : 'block';
                btnDelete.style.display = isDef ? 'none' : 'block';

                if(this.currentEditingPreset.warning) {
                    warningBox.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-1"></i>${this.currentEditingPreset.warning}`;
                    warningBox.classList.remove('hidden');
                } else {
                    warningBox.classList.add('hidden');
                }

                this.renderInjectorGrid();
                this.renderPresetItemsList();
            },

            renderInjectorGrid() {
                const grid = document.getElementById('injector-grid-display');
                grid.innerHTML = '';
                
                const items = this.currentEditingPreset.injectors;
                for (let i = 0; i < 9; i++) {
                    const item = items[i];
                    const cell = document.createElement('div');
                    cell.className = 'injector-grid-cell group';
                    
                    if (item && item.iconLink) { // item.iconLink のみでチェック
                        cell.innerHTML = `
                            <img src="${item.iconLink}" class="w-10 h-10 object-contain drop-shadow-md">
                            ${!this.currentEditingPreset.isDefault ? `<div class="remove-overlay" onclick="app.removeInjectorFromCurrentPreset(${i})"><i class="fa-solid fa-trash text-white"></i></div>` : ''}
                        `;
                    } else {
                        cell.innerHTML = `<i class="fa-solid fa-plus text-gray-800 text-xl group-hover:text-gray-600 transition"></i>`;
                        if (!this.currentEditingPreset.isDefault) {
                            cell.style.cursor = 'pointer';
                            cell.onclick = () => this.showInjectorPicker();
                        }
                    }
                    grid.appendChild(cell);
                }
            },

            renderPresetItemsList() {
                const list = document.getElementById('preset-items-list');
                const costEl = document.getElementById('preset-total-cost');
                list.innerHTML = '';

                let total = 0;
                this.currentEditingPreset.injectors.forEach((item, idx) => {
                    const price = item.priceData?.price || 0;
                    total += price;
                    const vendor = item.priceData?.vendor || 'Unknown';
                    const isTrader = item.priceData?.source === 'trader';

                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center bg-black/40 p-2 rounded border border-gray-800 hover:border-gray-600 transition';
                    row.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="text-xs text-gray-600 font-mono w-4">#${idx+1}</div>
                            <img src="${item.iconLink}" class="w-8 h-8 bg-[#111] rounded object-contain border border-gray-800">
                            <div>
                                <div class="text-sm font-bold text-gray-200">${item.shortName || item.name}</div>
                                <div class="text-[10px] ${isTrader ? 'text-tarkov-green' : 'text-blue-400'}">${vendor}</div>
                            </div>
                        </div>
                        <div class="text-right">
                             <div class="text-sm font-mono text-tarkov-green">₽${price.toLocaleString()}</div>
                             ${!this.currentEditingPreset.isDefault ? `<button class="text-red-500 hover:text-red-300 text-[10px]" onclick="app.removeInjectorFromCurrentPreset(${idx})">REMOVE</button>` : ''}
                        </div>
                    `;
                    list.appendChild(row);
                });

                if (this.currentEditingPreset.injectors.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-500 py-4 text-xs">No injectors added.</div>';
                }

                costEl.innerText = `₽${total.toLocaleString()}`;
            },

            // --- Injector Actions ---
            addInjectorToPreset(injectorId) {
                if (!this.currentEditingPreset || this.currentEditingPreset.isDefault) {
                    this.showToast("Cannot edit default preset. Copy it first.");
                    return;
                }
                
                if (this.currentEditingPreset.injectors.length >= 9) {
                    this.showToast("Case is full (Max 9).");
                    return;
                }

                const injector = this.data.injectorItems.find(i => i.id === injectorId);
                if (!injector) return;

                this.currentEditingPreset.injectors.push({
                    id: injector.id,
                    name: injector.name,
                    shortName: injector.shortName,
                    iconLink: injector.iconLink,
                    priceData: injector.priceData
                });

                this.renderLoadoutWorkspace();
                this.hideInjectorPicker();
            },

            removeInjectorFromCurrentPreset(index) {
                if (!this.currentEditingPreset || this.currentEditingPreset.isDefault) return;
                this.currentEditingPreset.injectors.splice(index, 1);
                this.renderLoadoutWorkspace();
            },

            // --- Injector Picker Modal ---
            showInjectorPicker() {
                if (!this.currentEditingPreset || this.currentEditingPreset.isDefault) {
                    if(this.currentEditingPreset?.isDefault) this.showToast("Cannot edit default preset. Click 'Save as New' first.");
                    return;
                }
                document.getElementById('injector-picker-modal')?.classList.remove('hidden');
                document.getElementById('injector-picker-search').value = '';
                this.renderInjectorPickerList();
            },

            hideInjectorPicker() {
                document.getElementById('injector-picker-modal')?.classList.add('hidden');
            },

            renderInjectorPickerList() {
                const searchInput = document.getElementById('injector-picker-search');
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                const listContainer = document.getElementById('injector-picker-list');
                if (!listContainer) return;

                const filteredInjectors = this.data.injectorItems.filter(item =>
                    item.name?.toLowerCase().includes(searchTerm) || item.shortName?.toLowerCase().includes(searchTerm)
                ).sort((a,b) => a.name.localeCompare(b.name));

                listContainer.innerHTML = filteredInjectors.map(item => {
                    const price = item.priceData?.price > 0 ? `₽${item.priceData.price.toLocaleString()}` : 'N/A';
                    const source = item.priceData?.vendor || 'Unknown';
                    return `
                        <button class="flex items-center gap-3 p-2 w-full text-left bg-black/40 hover:bg-white/5 rounded transition border border-gray-800 mb-1" onclick="app.addInjectorToPreset('${item.id}')">
                            <img src="${item.iconLink}" loading="lazy" alt="${item.shortName}" class="w-8 h-8 object-contain bg-[#222] rounded" onerror="this.style.display='none'">
                            <div>
                                <div class="text-sm text-white font-bold">${item.name}</div>
                                <div class="text-[10px] text-gray-400">Price: ${price} (${source})</div>
                            </div>
                        </button>
                    `;
                }).join('');
            },

            // --- RENDERERS ---
            renderWishlist() {
                const grid = document.getElementById('wishlist-grid');
                if(!grid) return;
                const countEl = document.getElementById('wishlist-count');
                
                if(this.data.wishlist.size === 0) {
                    grid.innerHTML = '<div class="text-center text-gray-500 py-10">No items in wishlist. Add items from Market.</div>';
                    countEl.innerText = "0 Items";
                    return;
                }

                const items = this.data.marketItems.filter(i => this.data.wishlist.has(i.id));
                countEl.innerText = `${items.length} Items`;
                
                grid.innerHTML = '';
                items.forEach(item => {
                    const priceFmt = item.avg24hPrice.toLocaleString();
                    const lowPrice = item.low24hPrice ? item.low24hPrice.toLocaleString() : '---';
                    const highPrice = item.high24hPrice ? item.high24hPrice.toLocaleString() : '---';
                    const isWish = this.data.wishlist.has(item.id);

                    const card = document.createElement('div');
                    card.className = 'tarkov-panel rounded p-3 flex items-center justify-between border border-tarkov-border hover:border-tarkov-gold transition';
                    card.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${item.iconLink}" loading="lazy" alt="${item.name}" class="w-10 h-10 bg-black rounded border border-gray-800" onerror="this.style.display='none'">
                            <div>
                                <h3 class="font-bold text-tarkov-gold text-sm">${item.name}</h3>
                                <div class="text-[10px] text-gray-500">
                                    Min: ₽${lowPrice} / Max: ₽${highPrice}
                                </div>
                            </div>
                        </div>
                        <div class="text-right flex items-center gap-4">
                            <div>
                                <div class="text-[9px] text-gray-500 uppercase">AVG PRICE</div>
                                <div class="text-lg font-bold font-mono text-tarkov-blue">₽${priceFmt}</div>
                            </div>
                            <button onclick="app.toggleWishlist('${item.id}')" class="text-red-500 hover:text-red-400 p-2"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            },

            renderMarket() {
                const searchInput = document.getElementById('market-search');
                const search = searchInput ? searchInput.value.toLowerCase().trim() : '';
                const cat = this.data.marketConfig.category;
                const filters = this.data.marketConfig.filters; 
                
                let results = this.data.marketItems;

                if (search.length > 0) {
                    results = results.filter(i => i.name.toLowerCase().includes(search) || (i.shortName && i.shortName.toLowerCase().includes(search)));
                } else if (cat !== 'all') {
                    const types = this.consts.typeMapping[cat];
                    if (types) results = results.filter(i => i.types.some(t => types.includes(t)));
                }
                
                if (filters.task) results = results.filter(i => i.reqData?.remaining?.task > 0);
                if (filters.hideout) results = results.filter(i => i.reqData?.remaining?.hideout > 0);
                if (filters.barter) results = results.filter(i => i.bartersFor && i.bartersFor.length > 0);
                if (filters.craft) results = results.filter(i => this.data.craftMap.has(i.id));

                const grid = document.getElementById('market-grid');
                if(!grid) return;
                grid.innerHTML = '';
                const display = results.slice(0, 50); 
                this.safeUpdateText('market-result-count', `${results.length} RESULTS`);

                if (display.length === 0) { grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">NO DATA FOUND</div>'; return; }

                display.forEach(item => {
                    const priceFmt = item.avg24hPrice.toLocaleString();
                    const lowPrice = item.low24hPrice ? item.low24hPrice.toLocaleString() : '---';
                    const highPrice = item.high24hPrice ? item.high24hPrice.toLocaleString() : '---';
                    const isWish = this.data.wishlist.has(item.id);

                    const req = item.reqData || { total: {task:0, hideout:0}, remaining: {task:0, hideout:0} };
                    const isTaskRem = req.remaining.task > 0;
                    const isHideRem = req.remaining.hideout > 0;
                    
                    const barters = item.bartersFor || [];
                    const craftUses = this.data.craftMap.get(item.id) || [];
                    const isBarter = barters.length > 0;
                    const isCraft = craftUses.length > 0;

                    let badges = '';
                    if(req.total.task > 0) {
                        const css = isTaskRem ? 'req-quest' : 'req-done';
                        badges += `<span class="req-badge ${css}"><i class="fa-solid fa-scroll"></i> TASK</span>`;
                    }
                    if(req.total.hideout > 0) {
                        const css = isHideRem ? 'req-hideout' : 'req-done';
                        badges += `<span class="req-badge ${css}"><i class="fa-solid fa-hammer"></i> HIDEOUT</span>`;
                    }
                    if(isBarter) badges += `<span class="req-badge req-barter"><i class="fa-solid fa-right-left"></i> BARTER</span>`;
                    if(isCraft) badges += `<span class="req-badge req-craft"><i class="fa-solid fa-wrench"></i> CRAFT</span>`;

                    const card = document.createElement('button');
                    card.className = 'market-card w-full text-left tarkov-panel rounded p-3 relative group touch-manipulation cursor-pointer border border-tarkov-border hover:border-tarkov-blue transition';
                    card.onclick = function(e) { 
                        if(e.target.closest('.wishlist-star')) return;
                        this.classList.toggle('expanded'); 
                        const expanded = this.classList.contains('expanded');
                        this.setAttribute('aria-expanded', expanded);
                    };
                    card.setAttribute('aria-expanded', 'false');

                    let craftIndicator = '';
                    if(isCraft) {
                        const maxProfit = Math.max(...craftUses.map(c => c.profit));
                        const pClass = maxProfit > 0 ? 'text-tarkov-green' : (maxProfit < 0 ? 'text-tarkov-red' : 'text-gray-500');
                        craftIndicator = `<div class="text-[10px] mt-1"><i class="fa-solid fa-chart-pie mr-1"></i>Craft Profit: <span class="${pClass}">₽${Math.round(maxProfit).toLocaleString()}</span></div>`;
                    }
                    
                    let reqMatrix = '';
                    if(req.total.task > 0 || req.total.hideout > 0) {
                        reqMatrix = `
                        <div class="bg-black/40 rounded p-1 border border-gray-800 text-[10px] min-w-[120px]">
                            <div class="flex justify-between px-2 text-gray-500 mb-1"><span>TYPE</span><span>REM / TOT</span></div>
                            ${req.total.task > 0 ? `<div class="flex justify-between px-2 py-0.5 ${isTaskRem ? 'text-tarkov-gold font-bold' : 'text-gray-600 line-through'}"><span>TASK</span><span>${req.remaining.task} / ${req.total.task}</span></div>` : ''}
                            ${req.total.hideout > 0 ? `<div class="flex justify-between px-2 py-0.5 ${isHideRem ? 'text-tarkov-green font-bold' : 'text-gray-600 line-through'}"><span>HIDE</span><span>${req.remaining.hideout} / ${req.total.hideout}</span></div>` : ''}
                        </div>`;
                    }

                    let taskListHtml = '';
                    if (item.usedInTasks && item.usedInTasks.length > 0) {
                        taskListHtml = item.usedInTasks.map(t => {
                            const tInfo = this.data.tasks.find(tk => tk.id === t.id);
                            const isDone = tInfo ? tInfo.completed : false;
                            const nameContent = t.wikiLink ? `<a href="${t.wikiLink}" target="_blank" class="hover:text-tarkov-accent hover:underline" onclick="event.stopPropagation()">${t.name}</a>` : t.name;
                            return `<div class="flex justify-between items-center py-1 border-b border-[#333] last:border-0 ${isDone ? 'text-gray-600' : 'text-gray-300'}"><span class="truncate pr-2 ${isDone ? 'line-through' : ''}">${nameContent}<span class="text-[9px] text-gray-500">(${t.trader.name})</span></span><span class="text-[9px] font-bold ${isDone ? 'text-gray-700' : 'text-tarkov-gold'}">${isDone ? 'DONE' : 'REQ'}</span></div>`;
                        }).join('');
                    }

                    let hideoutListHtml = '';
                    const hReqs = this.data.hideoutMap.get(item.id);
                    if (hReqs && hReqs.length > 0) {
                        hideoutListHtml = hReqs.map(h => {
                            const curLvl = this.data.userHideoutLevels[h.stationId] || 0;
                            const isDone = h.level <= curLvl;
                            return `<div class="flex justify-between items-center py-1 border-b border-[#333] last:border-0 ${isDone ? 'text-gray-600' : 'text-gray-300'}"><span class="truncate pr-2 ${isDone ? 'line-through' : ''}">${h.stationName} <span class="text-[9px] text-gray-500">(Lv${h.level})</span></span><span class="text-[9px] font-bold ${isDone ? 'text-gray-700' : 'text-tarkov-green'}">x${h.count}</span></div>`;
                        }).join('');
                    }

                    let acquisitionHtml = '';
                    const barterOffers = this.data.acquisitionMap.get(item.id) || [];
                    barterOffers.forEach(offer => {
                        const userLL = this.data.config.traderLevels[offer.traderName] || 4;
                        const isLocked = offer.level > userLL;
                        const lockedClass = isLocked ? 'opacity-50 grayscale border-red-900/50' : '';
                        const lockedBadge = isLocked ? `<span class="text-red-500 font-bold ml-2 text-[9px] border border-red-500 px-1 rounded">LL LOCKED</span>` : '';
                        const traderClass = isLocked ? 'text-red-500' : 'text-tarkov-green';

                        const ingredients = offer.ingredients.map(ing => `<div class="flex items-center gap-1 bg-[#222] px-1.5 py-0.5 rounded border border-[#444]"><span class="text-[10px] text-gray-300">${ing.item.name}</span><span class="text-[10px] text-tarkov-gold font-bold">x${ing.count}</span></div>`).join('');
                        acquisitionHtml += `<div class="bg-[#111] p-2 rounded border border-[#333] mb-2 last:mb-0 ${lockedClass}"><div class="text-[10px] text-gray-500 uppercase mb-1 flex items-center">TRADER: <span class="${traderClass} ml-1 mr-1">${offer.traderName} (LL${offer.level})</span> ${lockedBadge}</div><div class="flex flex-wrap gap-1">${ingredients}</div></div>`;
                    });

                    let usedInBarterHtml = '';
                    if (item.bartersFor && item.bartersFor.length > 0) {
                        const list = item.bartersFor.map(b => {
                            const rewards = b.rewardItems.map(r => r.item.name).join(', ');
                            return `<div class="flex justify-between items-center py-1 border-b border-[#333] last:border-0 text-gray-300"><span class="truncate pr-2 text-xs">${rewards}</span><span class="text-[10px] text-gray-500 whitespace-nowrap">${b.trader.name} LL${b.level}</span></div>`;
                        }).join('');
                        usedInBarterHtml = `<div class="mt-2 bg-[#0f0f0f] border border-[#333] rounded overflow-hidden"><div class="px-2 py-1 bg-[#1a1a1a] border-b border-[#333] flex items-center gap-2"><i class="fa-solid fa-right-left text-[#c084fc]"></i> <span class="font-bold text-[#c084fc] text-xs">USED IN BARTER</span></div><div class="p-2 space-y-1">${list}</div></div>`;
                    }

                    let usedInCraftHtml = '';
                    if (craftUses && craftUses.length > 0) {
                        const list = craftUses.map(c => {
                            const products = c.products.map(p => p.item.name).join(', ');
                            return `<div class="flex justify-between items-center py-1 border-b border-[#333] last:border-0 text-gray-300"><span class="truncate pr-2 text-xs">${products}</span><span class="text-[10px] text-gray-500 whitespace-nowrap">${c.station} Lv${c.level}</span></div>`;
                        }).join('');
                        usedInCraftHtml = `<div class="mt-2 bg-[#0f0f0f] border border-[#333] rounded overflow-hidden"><div class="px-2 py-1 bg-[#1a1a1a] border-b border-[#333] flex items-center gap-2"><i class="fa-solid fa-wrench text-[#60a5fa]"></i> <span class="font-bold text-[#60a5fa] text-xs">USED IN CRAFT</span></div><div class="p-2 space-y-1">${list}</div></div>`;
                    }

                    card.innerHTML = `
                        <div class="flex gap-4 items-center">
                            <div class="w-12 h-12 bg-[#111] border border-[#333] flex items-center justify-center rounded shrink-0 overflow-hidden relative"><img src="${item.iconLink}" loading="lazy" alt="${item.name}" class="w-10 h-10 object-contain absolute" onerror="this.style.display='none'"></div>
                            <div class="flex-1 min-w-0 grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
                                <div class="md:col-span-5"><h3 class="font-bold text-tarkov-gold text-sm truncate">${item.name}</h3><div class="mt-1 flex flex-wrap gap-1">${badges}</div></div>
                                <div class="md:col-span-3 text-right md:text-left"><div class="text-sm font-bold font-mono text-tarkov-blue">₽${priceFmt}</div><div class="text-[10px] ${item.changeLast48hPercent >= 0 ? 'text-tarkov-green' : 'text-tarkov-red'}">${item.changeLast48hPercent}% (24h)</div>${craftIndicator}</div>
                                <div class="md:col-span-4 flex justify-end items-center gap-3">${reqMatrix}<i class="fa-solid fa-star text-lg wishlist-star ${isWish ? 'active' : 'text-gray-700'}" onclick="app.toggleWishlist('${item.id}')"></i></div>
                            </div>
                        </div>
                        <div class="detail-section text-xs text-gray-400 cursor-auto">
                             <div class="grid grid-cols-2 gap-2 mb-3 bg-black/40 p-2 rounded border border-gray-800 text-center"><div><span class="text-[10px] text-gray-500 block">LOW (24h)</span><span class="text-gray-300 font-mono">₽${lowPrice}</span></div><div><span class="text-[10px] text-gray-500 block">HIGH (24h)</span><span class="text-gray-300 font-mono">₽${highPrice}</span></div></div>
                            <div class="space-y-2">
                                ${acquisitionHtml ? `<div class="mt-2"><h4 class="text-xs font-bold text-blue-400 uppercase mb-1 flex items-center gap-2"><i class="fa-solid fa-cart-shopping"></i> ACQUISITION (TRADERS)</h4><div class="space-y-1">${acquisitionHtml}</div></div>` : ''}
                                ${usedInBarterHtml}
                                ${usedInCraftHtml}
                                ${taskListHtml ? `<div class="bg-[#0f0f0f] border border-[#333] rounded overflow-hidden"><div class="px-2 py-1 bg-[#1a1a1a] border-b border-[#333] flex items-center gap-2"><i class="fa-solid fa-scroll text-tarkov-gold"></i> <span class="font-bold text-tarkov-gold">TASKS</span></div><div class="p-2 space-y-1">${taskListHtml}</div></div>` : ''}
                                ${hideoutListHtml ? `<div class="bg-[#0f0f0f] border border-[#333] rounded overflow-hidden"><div class="px-2 py-1 bg-[#1a1a1a] border-b border-[#333] flex items-center gap-2"><i class="fa-solid fa-dungeon text-tarkov-green"></i> <span class="font-bold text-tarkov-green">HIDEOUT</span></div><div class="p-2 space-y-1">${hideoutListHtml}</div></div>` : ''}
                            </div>
                            <div class="mt-4 flex justify-center bg-black/20 p-2 rounded border border-[#333]"><img src="${item.gridImageLink}" loading="lazy" alt="${item.name} grid image" class="max-w-full max-h-32 object-contain drop-shadow-lg" onerror="this.style.display='none'"></div>
                            <div class="text-center italic text-gray-600 pt-2 mt-2 border-t border-gray-800">Tap to close details</div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            },

            renderCrafts() {
                const grid = document.getElementById('crafts-grid');
                if(!grid) return;
                grid.innerHTML = '';
                
                const searchInput = document.getElementById('craft-search');
                const search = searchInput ? searchInput.value.toLowerCase().trim() : '';
                const st = this.data.marketConfig.station;
                const filters = this.data.marketConfig.craftFilters;

                let results = this.data.crafts;

                if (st !== 'all') results = results.filter(c => c.station.name.includes(st));

                if (search.length > 0) {
                    results = results.filter(c => {
                        const rewardMatch = c.rewardItems.some(r => r.item.name.toLowerCase().includes(search));
                        const ingredientMatch = c.requiredItems.some(req => req.item.name.toLowerCase().includes(search));
                        return rewardMatch || ingredientMatch;
                    });
                }

                if (filters.task || filters.hideout || filters.barter || filters.craft) {
                    results = results.filter(c => {
                        return c.rewardItems.some(r => {
                            const marketItem = this.data.marketItems.find(mi => mi.id === r.item.id);
                            if (!marketItem) return false;
                            const req = marketItem.reqData || { remaining: { task: 0, hideout: 0 } };
                            const taskMatch = filters.task && req.remaining.task > 0;
                            const hideoutMatch = filters.hideout && req.remaining.hideout > 0;
                            const barterMatch = filters.barter && (marketItem.bartersFor && marketItem.bartersFor.length > 0);
                            const craftMatch = filters.craft && this.data.craftMap.has(marketItem.id);
                            if (filters.task && !taskMatch) return false;
                            if (filters.hideout && !hideoutMatch) return false;
                            if (filters.barter && !barterMatch) return false;
                            if (filters.craft && !craftMatch) return false;
                            return true;
                        });
                    });
                }

                this.safeUpdateText('craft-result-count', `${results.length} RECIPES`);
                if(results.length === 0) { grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">NO CRAFTS FOUND</div>'; return; }

                results.slice(0, 50).forEach(craft => {
                    const profitFmt = Math.round(craft.profit).toLocaleString();
                    const costFmt = Math.round(craft.cost).toLocaleString();
                    
                    const mainReward = craft.rewardItems[0];
                    let reqBadges = '';
                    if (mainReward) {
                        const mItem = this.data.marketItems.find(mi => mi.id === mainReward.item.id);
                        if(mItem) {
                            const req = mItem.reqData;
                            if(req && req.remaining.task > 0) reqBadges += `<span class="req-badge req-quest"><i class="fa-solid fa-scroll"></i></span>`;
                            if(req && req.remaining.hideout > 0) reqBadges += `<span class="req-badge req-hideout"><i class="fa-solid fa-hammer"></i></span>`;
                        }
                    }

                    const rewards = craft.rewardItems.map(r => `<div class="flex items-center gap-2 mb-1"><img src="${r.item.iconLink}" loading="lazy" alt="${r.item.name}" class="w-6 h-6 bg-[#222] rounded" onerror="this.style.display='none'"><span class="text-tarkov-gold font-bold text-xs truncate">${r.item.name} x${r.count}</span> ${reqBadges}</div>`).join('');
                    
                    // Detailed Requirements rendering with source info
                    const reqs = craft.requiredItems.map(r => {
                        const bestPrice = this.getBestPrice(r.item.id);
                        const sourceClass = bestPrice.source === 'trader' ? 'cost-source-trader' : 'cost-source-flea';
                        const vendorText = bestPrice.source === 'trader' ? `<i class="fa-solid fa-shop"></i> ${bestPrice.vendor}` : `<i class="fa-solid fa-people-arrows"></i> Flea`;
                        
                        return `
                        <div class="flex justify-between items-center text-[10px] text-gray-400 border-b border-[#222] py-1 last:border-0">
                            <div class="flex items-center gap-2 truncate flex-1">
                                <span>${r.item.name}</span>
                                <span class="text-gray-600">x${r.count}</span>
                            </div>
                            <div class="text-right">
                                <span class="block ${sourceClass}">${vendorText}</span>
                                <span class="font-mono text-[9px]">₽${(bestPrice.price * r.count).toLocaleString()}</span>
                            </div>
                        </div>`;
                    }).join('');

                    const card = document.createElement('div');
                    card.className = 'tarkov-panel rounded p-3 flex flex-col relative border-l-4 ' + (craft.profit >= 0 ? 'border-l-green-600' : 'border-l-red-600');
                    card.innerHTML = `<div class="flex justify-between items-start mb-2"><span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">${craft.station.name} Lv${craft.level}</span><div class="text-right"><span class="block text-xs text-gray-500">PROFIT</span><span class="font-bold font-mono text-lg ${craft.profit >= 0 ? 'profit-pos' : 'profit-neg'}">₽${profitFmt}</span></div></div><div class="mb-3">${rewards}</div><div class="bg-[#111] p-2 rounded border border-[#333]"><div class="flex justify-between text-[10px] text-gray-500 mb-1 border-b border-[#333] pb-1"><span>INGREDIENTS (Best Source)</span><span>COST: ₽${costFmt}</span></div><div class="max-h-32 overflow-y-auto custom-scrollbar">${reqs}</div></div>`;
                    grid.appendChild(card);
                });
            },

            // --- HIDEOUT MANAGER ---
            renderHideout() {
                const grid = document.getElementById('hideout-grid');
                if(!grid) return;
                
                const stations = this.data.hideoutStationsRaw;
                if (!stations || stations.length === 0) { grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">Waiting for Data...</div>'; return; }

                stations.sort((a, b) => a.name.localeCompare(b.name));
                grid.innerHTML = '';
                
                let totalStations = stations.length;
                let maxLevelSum = 0;
                let currentLevelSum = 0;

                stations.forEach(station => {
                    const savedLevel = this.data.userHideoutLevels[station.id] || 0;
                    const maxLevel = Math.max(...station.levels.map(l => l.level));
                    maxLevelSum += maxLevel;
                    currentLevelSum += savedLevel;
                    
                    const nextLevel = savedLevel + 1;
                    const nextLevelData = station.levels.find(l => l.level === nextLevel);
                    const isMaxed = savedLevel >= maxLevel;

                    let reqHtml = '';
                    if (isMaxed) {
                        reqHtml = `<div class="text-tarkov-green text-xs font-bold text-center py-4 bg-green-900/10 rounded border border-green-900/30">MAX LEVEL REACHED</div>`;
                    } else if (nextLevelData) {
                        const items = nextLevelData.itemRequirements.map(req => `<div class="flex items-center gap-2 bg-[#111] p-1.5 rounded border border-[#333]"><img src="${req.item.iconLink}" loading="lazy" alt="${req.item.name}" class="w-6 h-6 object-contain bg-[#222] rounded" onerror="this.style.display='none'"><div class="min-w-0 flex-1"><div class="text-[10px] text-gray-300 truncate">${req.item.name}</div><div class="text-[9px] text-gray-500">x${req.count}</div></div></div>`).join('');
                        reqHtml = `<div class="space-y-1 mt-2 mb-1"><div class="text-[9px] text-gray-500 uppercase">Requirements for Lv${nextLevel}</div><div class="grid grid-cols-2 gap-1">${items}</div></div>`;
                    } else { reqHtml = `<div class="text-gray-500 text-xs text-center py-4">Data not available</div>`; }

                    const card = document.createElement('div');
                    card.className = `tarkov-panel rounded p-3 border ${isMaxed ? 'border-tarkov-green/30' : 'border-tarkov-border'} flex flex-col`;
                    card.innerHTML = `<div class="flex justify-between items-center mb-3"><h3 class="font-bold text-sm ${isMaxed ? 'text-tarkov-green' : 'text-gray-200'} truncate pr-2">${station.name}</h3><div class="flex items-center gap-1 bg-[#111] rounded p-1 border border-[#333]"><button class="hideout-level-btn" onclick="app.updateHideoutLevel('${station.id}', -1)" ${savedLevel <= 0 ? 'disabled' : ''}>-</button><span class="w-8 text-center font-mono font-bold ${isMaxed ? 'text-tarkov-green' : 'text-white'}">${savedLevel}</span><button class="hideout-level-btn" onclick="app.updateHideoutLevel('${station.id}', 1)" ${isMaxed ? 'disabled' : ''}>+</button></div></div><div class="flex-1">${reqHtml}</div>`;
                    grid.appendChild(card);
                });

                const progress = totalStations > 0 ? Math.round((currentLevelSum / maxLevelSum) * 100) : 0;
                this.safeUpdateHTML('dash-hideout-count', `${progress}%`);
                document.getElementById('hideout-progress-text').innerText = `${progress}% Completed`;
                document.getElementById('hideout-progress-bar').style.width = `${progress}%`;
            },

            updateHideoutLevel(stationId, change) {
                const stations = this.data.hideoutStationsRaw;
                const station = stations.find(s => s.id === stationId);
                if (!station) return;
                const maxLevel = Math.max(...station.levels.map(l => l.level));
                let current = this.data.userHideoutLevels[stationId] || 0;
                let next = current + change;
                if (next < 0) next = 0;
                if (next > maxLevel) next = maxLevel;
                this.data.userHideoutLevels[stationId] = next;
                this.saveHideoutStatus();
                this.calculateAllRequirements(); 
                this.renderHideout();
                this.renderMarket();
            },

            loadHideoutStatus() { const s = localStorage.getItem('userHideoutLevels'); if (s) { try { this.data.userHideoutLevels = JSON.parse(s); } catch (e) { this.data.userHideoutLevels = {}; } } },
            saveHideoutStatus() { localStorage.setItem('userHideoutLevels', JSON.stringify(this.data.userHideoutLevels)); },

            // --- GUNSMITH MODULE ---
            async fetchWeaponData() {
                const query = `{ items(types: [gun], lang: ja) { id name shortName types } }`;
                const data = await this.fetchApiData(query);
                if (data && data.items) {
                    this.data.weapons = data.items.filter((v,i,a)=>a.findIndex(t=>(t.id === v.id))===i).sort((a, b) => a.name.localeCompare(b.name));
                    this.setupGunsmith();
                }
            },

            setupGunsmith() {
                const select = document.getElementById('gs-weapon');
                if(!select) return;
                if (this.data.weapons.length === 0) { select.innerHTML = `<option value="">Waiting for Sync...</option>`; return; }
                const groups = this.data.weapons.reduce((g, w) => {
                    const fam = w.shortName ? w.shortName.split(' ')[0] : 'Other';
                    if (!g[fam]) g[fam] = [];
                    g[fam].push(w);
                    return g;
                }, {});
                let opts = `<option value="">Select Weapon...</option>`;
                for (const gn in groups) {
                    opts += `<optgroup label="${gn}">`;
                    groups[gn].forEach(w => opts += `<option value="${w.id}">${w.name}</option>`); 
                    opts += `</optgroup>`;
                }
                select.innerHTML = opts;
            },

            async buildGun(id) {
                if (!id) return;
                this.safeUpdateHTML('gs-builder-area', '<div class="flex justify-center py-10 opacity-50"><div class="loader"></div></div>');
                this.safeUpdateText('gs-stat-ergo', '-');
                this.safeUpdateText('gs-stat-recoil', '-');
                const query = `{ 
                    items(ids: ["${id}"], lang: ja) {
                        id name shortName description basePrice width height inspectImageLink gridImageLink
                        properties { 
                            ... on ItemPropertiesWeapon { 
                                ergonomics recoilVertical recoilHorizontal fireRate caliber
                                defaultPreset { inspectImageLink gridImageLink } 
                                slots {
                                    name
                                    filters { allowedItems { id name shortName gridImageLink properties { ... on ItemPropertiesWeaponMod { ergonomics recoilModifier } } } }
                                }
                            }
                        }
                    }
                }`;
                const data = await this.fetchApiData(query);
                if (data && data.items && data.items.length > 0) {
                    this.data.currentBuild = { baseWeapon: data.items[0], attachedParts: [] };
                    this.renderGunBuilder(this.data.currentBuild);
                } else {
                    this.showToast("Failed to load weapon details");
                    this.safeUpdateHTML('gs-builder-area', '<div class="text-center text-red-500 py-10">Error loading weapon data</div>');
                }
            },

            disassemble() {
                if (!this.data.currentBuild) { this.showToast("Select a weapon first"); return; }
                this.data.currentBuild.attachedParts = [];
                this.renderGunBuilder(this.data.currentBuild);
                this.showToast("Weapon Disassembled");
            },

            autoAssemble() {
                if (!this.data.currentBuild) { this.showToast("Select a weapon first"); return; }
                const targetErgo = parseFloat(document.getElementById('gs-target-ergo').value);
                const hasTarget = !isNaN(targetErgo);
                this.showToast(hasTarget ? `Targeting Ergo ~${targetErgo}...` : "Auto-Building (Max Ergo)...");
                const baseWeapon = this.data.currentBuild.baseWeapon;
                const slots = baseWeapon.properties?.slots || [];
                this.data.currentBuild.attachedParts = [];
                const getItems = (slot) => {
                    if (!slot.filters) return [];
                    if (Array.isArray(slot.filters)) { return slot.filters[0] && slot.filters[0].allowedItems ? slot.filters[0].allowedItems : []; }
                    if (slot.filters.allowedItems) return slot.filters.allowedItems;
                    return [];
                };
                if (hasTarget) {
                    const slotCandidates = slots.map(slot => {
                        const items = getItems(slot);
                        if (!items || items.length === 0) return { slotName: slot.name, items: [] };
                        return { slotName: slot.name, items: items.sort((a, b) => (b.properties?.ergonomics || 0) - (a.properties?.ergonomics || 0)) };
                    });
                    const currentParts = slotCandidates.map(sc => sc.items[0]).filter(p => p); 
                    const calcErgo = (parts) => {
                        let e = baseWeapon.properties?.ergonomics || 0;
                        parts.forEach(p => e += (p.properties?.ergonomics || 0));
                        return e;
                    };
                    let currentTotal = calcErgo(currentParts);
                    let improved = true;
                    let loops = 0;
                    while (improved && currentTotal > targetErgo && loops < 50) {
                        improved = false;
                        loops++;
                        let bestSwap = null;
                        let minDiff = Math.abs(currentTotal - targetErgo);
                        for (let i = 0; i < slotCandidates.length; i++) {
                            const sc = slotCandidates[i];
                            const currentPart = currentParts.find(p => sc.items.includes(p)); 
                            if (!currentPart) continue; 
                            const currentIndex = sc.items.indexOf(currentPart); 
                            if (currentIndex + 1 < sc.items.length) {
                                const nextPart = sc.items[currentIndex + 1];
                                const ergoDiff = (currentPart.properties?.ergonomics || 0) - (nextPart.properties?.ergonomics || 0);
                                const newTotal = currentTotal - ergoDiff;
                                const diff = Math.abs(newTotal - targetErgo);
                                if (diff < minDiff) { minDiff = diff; bestSwap = { index: i, oldPart: currentPart, newPart: nextPart, newTotal: newTotal }; }
                            }
                        }
                        if (bestSwap) {
                            const oldIdx = currentParts.indexOf(bestSwap.oldPart);
                            if (oldIdx > -1) { currentParts[oldIdx] = bestSwap.newPart; currentTotal = bestSwap.newTotal; improved = true; }
                        }
                    }
                    currentParts.forEach(p => {
                        const candidate = slotCandidates.find(sc => sc.items.includes(p));
                        if(candidate) { this.data.currentBuild.attachedParts.push({ slotName: candidate.slotName, part: p }); }
                    });
                } else {
                    slots.forEach(slot => {
                        let items = getItems(slot);
                        if (!items || items.length === 0) return;
                        items.sort((a, b) => (b.properties?.ergonomics || 0) - (a.properties?.ergonomics || 0));
                        const bestPart = items[0];
                        if (bestPart) { this.data.currentBuild.attachedParts.push({ slotName: slot.name, part: bestPart }); }
                    });
                }
                this.renderGunBuilder(this.data.currentBuild);
                this.showToast("Assembly Complete");
            },

            renderGunBuilder(build) {
                const item = build.baseWeapon;
                const props = item.properties || {};
                let ergo = props.ergonomics || 0;
                let recoil = props.recoilVertical || 0;
                let modSum = 0;
                build.attachedParts.forEach(ap => {
                    const pProps = ap.part.properties || {};
                    if(pProps.ergonomics) ergo += pProps.ergonomics;
                    if(pProps.recoilModifier) modSum += pProps.recoilModifier;
                });
                const finalRecoil = recoil * (1 + (modSum / 100));
                this.safeUpdateText('gs-stat-ergo', Math.round(ergo));
                this.safeUpdateText('gs-stat-recoil', Math.round(finalRecoil));
                let imgUrl = item.properties?.defaultPreset?.inspectImageLink || item.inspectImageLink || item.gridImageLink || '';
                let caliber = props.caliber ? props.caliber.replace('Caliber', '') : 'Unknown';
                let html = `
                    <div class="glass-panel p-4 md:p-6 rounded animate-fade-in relative overflow-hidden group">
                        <div class="absolute -top-6 -right-6 text-9xl font-bold text-white opacity-[0.03] select-none pointer-events-none transition-transform group-hover:scale-110 duration-700">${item.shortName}</div>
                        <div class="flex flex-col md:flex-row gap-6 items-start relative z-10">
                            <div class="w-full md:w-5/12">
                                <div class="bg-black/20 rounded-lg p-6 border border-gray-800 flex items-center justify-center min-h-[200px] relative">
                                    <img src="${imgUrl}" loading="lazy" alt="${item.name}" class="w-full h-auto object-contain drop-shadow-2xl" onerror="this.src='https://via.placeholder.com/200x100?text=No+Image'">
                                </div>
                                <div class="mt-3 flex justify-between text-[10px] text-gray-500 font-mono px-1"><span>${item.width}x${item.height} CELLS</span><span>${caliber}</span></div>
                            </div>
                            <div class="w-full md:w-7/12 space-y-5">
                                <div>
                                    <h3 class="text-xl md:text-2xl font-bold text-white leading-tight font-mono">${item.name}</h3>
                                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4">
                                        <div class="bg-[#0a0a0a] p-2 rounded border border-gray-800"><div class="text-[9px] text-gray-500">RPM</div><div class="text-tarkov-green font-mono font-bold">${props.fireRate || '-'}</div></div>
                                        <div class="bg-[#0a0a0a] p-2 rounded border border-gray-800"><div class="text-[9px] text-gray-500">H. RECOIL</div><div class="text-gray-300 font-mono">${props.recoilHorizontal || '-'}</div></div>
                                    </div>
                                </div>
                                <div class="border-t border-gray-800 pt-4">
                                    <h4 class="text-xs text-gray-500 uppercase font-bold mb-2">Available Slots</h4>
                                    <div class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                                        ${(props.slots || []).map(slot => {
                                            const attached = build.attachedParts.find(p => p.slotName === slot.name);
                                            return `<div class="bg-black/40 p-2 rounded border border-gray-800 flex justify-between items-center group/slot"><span class="text-xs text-gray-400 font-mono">${slot.name}</span><div class="flex items-center gap-2">${attached ? `<span class="text-tarkov-accent text-xs truncate max-w-[150px]" title="${attached.part.name}">${attached.part.name}</span><button class="text-red-500 hover:text-red-400" onclick="app.removePart('${slot.name}')"><i class="fa-solid fa-times"></i></button>` : `<button class="text-xs bg-gray-800 hover:bg-gray-700 px-2 py-1 rounded text-gray-300" onclick='app.showParts("${slot.name}")'>Select Part</button>`}</div></div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="gs-part-selector" class="hidden mt-4 border-t border-gray-700 pt-4 animate-fade-in scroll-mt-20"><div class="flex justify-between items-center mb-2"><h4 class="text-xs text-tarkov-accent uppercase font-bold">Select Part</h4><button onclick="document.getElementById('gs-part-selector').classList.add('hidden')" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button></div><div id="gs-part-list" class="grid grid-cols-2 sm:grid-cols-4 gap-2 max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                    </div>
                `;
                this.safeUpdateHTML('gs-builder-area', html);
            },

            showParts(slotName) {
                const container = document.getElementById('gs-part-selector');
                const list = document.getElementById('gs-part-list');
                const title = container.querySelector('h4'); 
                container.classList.remove('hidden');
                const slot = this.data.currentBuild.baseWeapon.properties.slots.find(s => s.name === slotName);
                if(title) title.innerText = `Select Part: ${slotName}`;
                let items = [];
                if (slot && slot.filters) {
                    if (Array.isArray(slot.filters)) { items = slot.filters[0] ? slot.filters[0].allowedItems : []; } 
                    else if (slot.filters.allowedItems) { items = slot.filters.allowedItems; }
                }
                if(!items || items.length === 0) {
                    list.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">No compatible parts found for this slot.</div>';
                    setTimeout(() => container.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
                    return;
                }
                this.data.currentSlotCandidates = items;
                list.innerHTML = items.map(p => `<div class="bg-[#0f0f0f] border border-gray-800 p-2 rounded hover:border-tarkov-accent cursor-pointer flex flex-col items-center gap-1 group transition-all hover:bg-white/5" onclick='app.attachPart("${slotName}", "${p.id}")' title="${p.name}"><img src="${p.gridImageLink}" loading="lazy" alt="${p.name}" class="w-12 h-12 object-contain group-hover:scale-110 transition" onerror="this.style.opacity=0.3"><span class="text-[10px] text-gray-400 text-center truncate w-full group-hover:text-white">${p.name}</span></div>`).join('');
                setTimeout(() => { container.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 100);
            },

            attachPart(slotName, partId) {
                const part = this.data.currentSlotCandidates.find(p => p.id === partId);
                if (!part) return;
                this.data.currentBuild.attachedParts = this.data.currentBuild.attachedParts.filter(p => p.slotName !== slotName);
                this.data.currentBuild.attachedParts.push({ slotName, part });
                this.renderGunBuilder(this.data.currentBuild);
            },

            removePart(slotName) {
                this.data.currentBuild.attachedParts = this.data.currentBuild.attachedParts.filter(p => p.slotName !== slotName);
                this.renderGunBuilder(this.data.currentBuild);
            },

            // --- GENERAL & HELPERS ---
            processTaskMetaData() {
                const traderSet = new Set();
                const mapSet = new Set();
                this.data.tasks.forEach(t => {
                    if(t.trader?.name) traderSet.add(t.trader.name);
                    if(t.map?.name) mapSet.add(t.map.name);
                });
                const trSelect = document.getElementById('filter-trader');
                if(trSelect) trSelect.innerHTML = '<option value="all">全トレーダー</option>' + Array.from(traderSet).sort().map(t => `<option value="${t}">${t}</option>`).join('');
                const mapSelect = document.getElementById('filter-map');
                if(mapSelect) mapSelect.innerHTML = '<option value="all">全マップ</option>' + Array.from(mapSet).sort().map(m => `<option value="${m}">${m}</option>`).join('');
            },

            renderTasks() {
                const searchInput = document.getElementById('task-search');
                const search = searchInput ? searchInput.value.toLowerCase() : '';
                const trader = document.getElementById('filter-trader')?.value || 'all';
                const map = document.getElementById('filter-map')?.value || 'all';
                const type = document.getElementById('filter-type')?.value || 'all';
                const hideCompleted = document.getElementById('hide-completed')?.checked || false;
                const sortBy = document.getElementById('sort-by')?.value || 'minPlayerLevel';

                let filtered = this.data.tasks.filter(t => {
                    const searchTargets = [ t.name, t.map?.name || '', t.trader?.name || '', ...(t.objectives?.map(o => o.description) || []), ...(t.startRewards?.items?.map(i => i.item.name) || []), ...(t.finishRewards?.items?.map(i => i.item.name) || []) ].map(s => (s || '').toLowerCase());
                    const mSearch = searchTargets.some(s => s.includes(search));
                    const mTrader = trader === 'all' || t.trader?.name === trader;
                    const mMap = map === 'all' || t.map?.name === map; 
                    let mType = true;
                    if (type === 'kappa') mType = t.kappaRequired;
                    if (type === 'lightkeeper') mType = t.lightkeeperRequired;
                    return mSearch && mTrader && mMap && mType;
                });

                if (hideCompleted) filtered = filtered.filter(t => !t.completed);
                filtered.sort((a, b) => {
                    let valA, valB;
                    if (sortBy === 'trader') { valA = a.trader?.name || ''; valB = b.trader?.name || ''; } 
                    else if (sortBy === 'name') { valA = a.name; valB = b.name; } 
                    else { valA = a.minPlayerLevel || 0; valB = b.minPlayerLevel || 0; }
                    if (typeof valA === 'string') return valA.localeCompare(valB);
                    return valA - valB;
                });

                const list = document.getElementById('task-list');
                if (filtered.length === 0) { list.innerHTML = `<div class="text-center text-gray-500 py-10">No tasks match your criteria.</div>`; return; }

                list.innerHTML = filtered.slice(0, search ? 100 : 50).map(t => {
                    let rewardsHtml = '';
                    const processRew = (rew, type) => {
                        if(!rew) return '';
                        let html = '';
                        if(rew.traderStanding) rew.traderStanding.forEach(r => html += `<li>${r.trader.name}: ${r.standing}</li>`);
                        if(rew.items) rew.items.forEach(i => html += `<li class="flex items-center gap-2 mb-1"><img src="${i.item.gridImageLink || ''}" loading="lazy" class="w-5 h-5 object-contain bg-black/50 rounded" onerror="this.style.display='none'"><span>${i.item.name} x${i.count}</span></li>`);
                        return html ? `<div class="mt-2"><h4 class="text-xs font-bold text-gray-500 uppercase">${type}</h4><ul class="list-none text-xs text-gray-400">${html}</ul></div>` : '';
                    };
                    rewardsHtml += processRew(t.startRewards, 'Start Rewards');
                    rewardsHtml += processRew(t.finishRewards, 'Finish Rewards');
                    
                    let sherpaData = this.consts.sherpaIntelDB[t.name];
                    let sherpaAdvice = "";
                    if (sherpaData) {
                        sherpaAdvice = sherpaData.desc || sherpaData;
                        if(sherpaData.tips && sherpaData.tips.length > 0) { sherpaAdvice += `<ul class="list-none mt-2 space-y-1">${sherpaData.tips.map(tip => `<li class="text-xs text-blue-300"><i class="fa-solid fa-angle-right mr-1"></i>${tip}</li>`).join('')}</ul>`; }
                    } else { sherpaAdvice = "No specific advice available."; }

                    return `
                    <div class="glass-panel rounded overflow-hidden border-l-2 ${t.kappaRequired ? 'border-tarkov-accent' : 'border-gray-600'}">
                        <button class="task-accordion-header w-full text-left p-3 flex flex-col sm:flex-row sm:items-center gap-2 cursor-pointer hover:bg-white/5" aria-expanded="false" data-task-id="${t.id}" onclick="app.toggleTaskAccordion(this)">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-tarkov-accent rounded border-gray-600 bg-gray-700 focus:ring-tarkov-accent" onclick="event.stopPropagation(); app.toggleTaskCompleted('${t.id}')" ${t.completed ? 'checked' : ''}>
                            <div class="flex-1">
                                <div class="text-[10px] text-gray-500 uppercase flex items-center gap-2"><span>${t.trader?.name}</span>${t.minPlayerLevel ? '<span class="bg-gray-800 px-1 rounded">Lvl '+t.minPlayerLevel+'</span>' : ''}</div>
                                <div class="font-bold text-sm text-gray-200">${t.name}</div>
                                <div class="text-xs text-gray-500"><i class="fa-solid fa-map-location-dot mr-1"></i>${t.map?.name || 'Any'}</div>
                            </div>
                            <div class="flex items-center gap-3 mt-2 sm:mt-0">
                                ${t.kappaRequired ? '<span class="px-2 py-0.5 bg-yellow-900/40 text-tarkov-accent text-[10px] font-bold rounded border border-yellow-800/50">KAPPA</span>' : ''}
                                <i class="task-accordion-icon fa-solid fa-chevron-down transform transition-transform duration-300 ml-auto"></i>
                            </div>
                        </button>
                        <div class="task-accordion-content overflow-hidden max-h-0 transition-all duration-300 ease-in-out bg-black/20">
                            <div class="p-4 border-t border-gray-800 space-y-4">
                                <div><h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Objectives</h3><ul class="list-disc pl-4 space-y-1 text-sm text-gray-300">${t.objectives?.map(o => `<li>${o.description}</li>`).join('') || '<li>Check wiki</li>'}</ul></div>
                                ${rewardsHtml}
                                <div class="bg-blue-900/10 border-l-4 border-blue-600 p-3">
                                    <h3 class="text-xs font-bold text-blue-400 uppercase mb-1">Sherpa Advice</h3>
                                    <div class="text-sm text-gray-300 leading-relaxed">${sherpaAdvice}</div>
                                </div>
                                <div class="pt-2"><a href="${t.wikiLink || '#'}" target="_blank" class="text-sm text-tarkov-accent hover:underline flex items-center gap-2">Wiki Link <i class="fa-solid fa-external-link-alt"></i></a></div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },

            // --- UTILITIES ---
            switchTab(id) {
                ['dashboard', 'tasks', 'gunsmith', 'hideout', 'ammo', 'market', 'wishlist', 'settings', 'loadout'].forEach(t => document.getElementById(`view-${t}`)?.classList.add('hidden'));
                document.getElementById(`view-${id}`).classList.remove('hidden');
                document.querySelectorAll('.nav-btn-desktop').forEach(b => {
                    const active = b.dataset.target === id;
                    b.classList.toggle('bg-tarkov-border', active);
                    b.classList.toggle('text-tarkov-accent', active);
                    b.classList.toggle('border-tarkov-accent', active);
                    b.classList.toggle('border-transparent', !active);
                });
                document.querySelectorAll('.nav-btn-mobile').forEach(b => {
                    const active = b.dataset.target === id;
                    b.classList.toggle('mobile-nav-active', active);
                    b.classList.toggle('text-gray-500', !active);
                });
                // Shortcuts handling
                document.querySelectorAll('.nav-btn-shortcut').forEach(b => {
                     const active = b.dataset.target === id;
                     if(active) {
                        // Optional: Highlight shortcut button if needed
                     }
                });

                document.getElementById('main-content').scrollTop = 0;
            },

            setupListeners() {
                // FIXED: Event Delegation for static buttons
                const syncBtn = document.getElementById('sync-btn');
                if(syncBtn) syncBtn.addEventListener('click', () => this.fetchLiveStats());

                document.querySelectorAll('.nav-btn-desktop, .nav-btn-mobile, .nav-btn-shortcut').forEach(btn => {
                    btn.addEventListener('click', (e) => this.switchTab(e.currentTarget.dataset.target));
                });

                document.querySelectorAll('.market-nav-tab').forEach(btn => {
                    btn.addEventListener('click', (e) => this.switchMarketTab(e.currentTarget.dataset.tab));
                });

                document.querySelectorAll('.filter-toggle-btn').forEach(btn => {
                    // Determine if market or craft filter
                    if(btn.id.includes('filter-craft-')) {
                         btn.addEventListener('click', (e) => this.toggleCraftFilter(e.currentTarget.dataset.filter));
                    } else {
                         btn.addEventListener('click', (e) => this.toggleMarketFilter(e.currentTarget.dataset.filter));
                    }
                });

                // Settings: Game Mode Radio
                document.querySelectorAll('input[name="gameMode"]').forEach(radio => {
                    radio.addEventListener('change', (e) => this.updateGameMode(e.target.value));
                });
                
                const avChart = document.getElementById('av-chart');
                if(avChart) avChart.addEventListener('click', () => this.switchAmmoView('chart'));
                
                const avList = document.getElementById('av-list');
                if(avList) avList.addEventListener('click', () => this.switchAmmoView('list'));

                const ammoSelect = document.getElementById('ammo-select');
                if(ammoSelect) {
                    ammoSelect.addEventListener('change', (e) => {
                        this.data.ammoConfig.caliber = e.target.value;
                        this.updateAmmoVisuals();
                    });
                }
                
                const ammoColor = document.getElementById('ammo-color-mode');
                if(ammoColor) ammoColor.addEventListener('change', (e) => { this.data.ammoConfig.colorMode = e.target.value; this.updateAmmoVisuals(); });

                const afHide = document.getElementById('af-hide-unavail');
                if(afHide) afHide.addEventListener('change', (e) => { this.data.ammoConfig.filters.hideUnavailable = e.target.checked; this.updateAmmoVisuals(); });
                
                const afTrader = document.getElementById('af-trader-only');
                if(afTrader) afTrader.addEventListener('change', (e) => { this.data.ammoConfig.filters.traderOnly = e.target.checked; this.updateAmmoVisuals(); });

                const gsDisassemble = document.getElementById('gs-disassemble');
                if(gsDisassemble) gsDisassemble.addEventListener('click', () => this.disassemble());

                const gsAuto = document.getElementById('gs-auto');
                if(gsAuto) gsAuto.addEventListener('click', () => this.autoAssemble());

                const injectorSearchInput = document.getElementById('injector-picker-search');
                if(injectorSearchInput) injectorSearchInput.addEventListener('input', this.debounce(() => this.renderInjectorPickerList(), 300));

                // Apply debounce to searches
                ['task-search', 'market-search', 'craft-search'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        const renderer = id === 'task-search' ? this.renderTasks : (id === 'market-search' ? this.renderMarket : this.renderCrafts);
                        el.addEventListener('input', this.debounce(() => renderer.call(this), 300));
                    }
                });

                ['filter-trader', 'filter-map', 'filter-type', 'hide-completed', 'sort-by'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.addEventListener('change', () => this.renderTasks());
                });
                
                document.querySelectorAll('#market-category-filters button').forEach(b => b.addEventListener('click', (e) => {
                    document.querySelectorAll('#market-category-filters button').forEach(bb => bb.classList.remove('active', 'text-white'));
                    e.target.classList.add('active', 'text-white');
                    this.data.marketConfig.category = e.target.dataset.type;
                    this.renderMarket();
                }));
                document.querySelectorAll('#craft-filters button').forEach(b => b.addEventListener('click', (e) => {
                    document.querySelectorAll('#craft-filters button').forEach(bb => bb.classList.remove('active', 'text-white'));
                    e.target.classList.add('active', 'text-white');
                    this.data.marketConfig.station = e.target.dataset.station;
                    this.renderCrafts();
                }));
            },

            toggleTaskAccordion(header) {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.task-accordion-icon');
                if (content.style.maxHeight) { 
                    content.style.maxHeight = null; 
                    icon.classList.remove('rotate-180');
                    header.setAttribute('aria-expanded', 'false');
                } else { 
                    content.style.maxHeight = content.scrollHeight + "px"; 
                    icon.classList.add('rotate-180');
                    header.setAttribute('aria-expanded', 'true');
                }
            },

            toggleTaskCompleted(taskId) {
                const idx = this.data.tasks.findIndex(t => t.id === taskId);
                if (idx !== -1) {
                    this.data.tasks[idx].completed = !this.data.tasks[idx].completed;
                    this.saveTaskCompletionStatus();
                    this.calculateAllRequirements(); 
                    this.renderTasks();
                    if(!document.getElementById('view-market').classList.contains('hidden')) { this.renderMarket(); }
                }
            },

            loadTaskCompletionStatus() {
                const s = localStorage.getItem('taskCompletionStatus');
                if (s) { const map = JSON.parse(s); this.data.tasks.forEach(t => t.completed = map[t.id] || false); }
            },
            saveTaskCompletionStatus() {
                const map = {}; this.data.tasks.forEach(t => { if(t.completed) map[t.id] = true; });
                localStorage.setItem('taskCompletionStatus', JSON.stringify(map));
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.classList.remove('opacity-0', 'pointer-events-none');
                t.classList.add('animate-bounce');
                setTimeout(() => { t.classList.add('opacity-0', 'pointer-events-none'); t.classList.remove('animate-bounce'); }, 2500);
            }
        };

        app.init();
    </script>
</body>
</html>