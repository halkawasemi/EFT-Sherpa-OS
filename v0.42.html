<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EFT Sherpa OS v0.42</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        tarkov: {
                            bg: '#0f0f0f',
                            panel: '#151515',
                            border: '#333333',
                            text: '#cccccc',
                            accent: '#9a8c7d', 
                            accentHover: '#b09b75',
                            green: '#4ade80',
                            red: '#ef4444',
                            orange: '#f97316',
                            gold: '#ffd700',
                            blue: '#4a6fa5'
                        }
                    },
                    fontFamily: {
                        mono: ['Consolas', 'Monaco', 'Courier New', 'monospace'],
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #050505; color: #d4d4d4; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
        
        /* CRT Overlay */
        .crt-overlay {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 40;
        }

        .glass-panel { background: rgba(26, 26, 26, 0.95); border: 1px solid #333; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .loader { border: 2px solid #333; border-top: 2px solid #9a8c7d; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animation */
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile Nav Active State */
        .mobile-nav-active { color: #9a8c7d; border-top: 2px solid #9a8c7d; background: linear-gradient(to bottom, rgba(154, 140, 125, 0.1), transparent); }

        /* --- Market Monitor Specific Styles --- */
        .req-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 3px; font-weight: bold; letter-spacing: 0.05em; display: inline-flex; align-items: center; gap: 4px; margin-right: 4px; transition: all 0.3s; }
        
        /* Active States */
        .req-quest { background: rgba(234, 179, 8, 0.2); color: #fbbf24; border: 1px solid rgba(234, 179, 8, 0.4); }
        .req-hideout { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.4); }
        .req-barter { background: rgba(192, 132, 252, 0.2); color: #c084fc; border: 1px solid rgba(192, 132, 252, 0.4); }
        
        /* Phase 3: Inactive/Completed States */
        .req-done { background: rgba(60, 60, 60, 0.2); color: #666; border: 1px solid rgba(60, 60, 60, 0.4); opacity: 0.6; text-decoration: line-through; }
        
        .profit-pos { color: #4ade80; }
        .profit-neg { color: #ef4444; }
        
        /* Market Accordion */
        .detail-section { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out, margin-top 0.3s; }
        .market-card.expanded .detail-section { max-height: 2000px; opacity: 1; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #444; }
        .market-card.expanded { background-color: #252525; border-color: #4a6fa5; box-shadow: 0 0 15px rgba(74, 111, 165, 0.1); }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Market Tab Navigation */
        .market-nav-tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; color: #666; border-bottom: 2px solid transparent; transition: all 0.3s; font-weight: bold; font-size: 0.8rem; }
        .market-nav-tab.active { color: #9a8c7d; border-bottom-color: #9a8c7d; background: linear-gradient(to top, rgba(154, 140, 125, 0.1), transparent); }
        
        /* Hideout Specific */
        .hideout-level-btn { width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: #222; color: #666; transition: all 0.2s; }
        .hideout-level-btn:hover:not(:disabled) { background: #333; color: #fff; }
        .hideout-level-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Filter Checkbox Button Style (Phase 4) */
        .filter-toggle-btn {
            font-size: 0.75rem; padding: 4px 10px; border-radius: 4px; border: 1px solid #333; background: #1a1a1a; color: #666; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .filter-toggle-btn.active {
            background: rgba(154, 140, 125, 0.2); border-color: #9a8c7d; color: #9a8c7d;
        }
        .filter-toggle-btn:hover:not(.active) { background: #252525; color: #aaa; }
        
        /* Safe Area for iPhone */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden relative text-sm md:text-base">
    
    <div class="crt-overlay fixed inset-0 h-full w-full pointer-events-none"></div>

    <!-- Header -->
    <header class="h-14 bg-tarkov-panel border-b border-tarkov-border flex items-center justify-between px-4 md:px-6 z-50 shrink-0 shadow-md">
        <div class="flex items-center gap-2 md:gap-3">
            <i class="fa-solid fa-layer-group text-tarkov-accent text-lg md:text-xl"></i>
            <h1 class="font-bold text-base md:text-lg tracking-wider text-tarkov-accent">EFT SHERPA <span class="text-white opacity-60">OS</span> v0.42 <span class="text-[10px] bg-tarkov-green text-black px-1 rounded ml-1 align-top">PvE</span></h1>
        </div>
        
        <div class="flex items-center gap-2 md:gap-4">
            <button onclick="app.fetchLiveStats()" id="sync-btn" class="text-xs flex items-center gap-2 bg-tarkov-border hover:bg-gray-700 transition px-3 py-2 rounded text-gray-300 border border-tarkov-border active:scale-95">
                <i class="fa-solid fa-rotate"></i> <span class="hidden md:inline">LIVE SYNC</span><span class="md:hidden">SYNC</span>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- Sidebar (PC) -->
        <nav class="w-64 bg-tarkov-panel border-r border-tarkov-border flex flex-col z-30 hidden md:flex">
            <div class="p-4 border-b border-tarkov-border">
                <div class="text-xs text-gray-500 uppercase font-bold mb-2">Command</div>
                <button onclick="app.switchTab('dashboard')" class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 bg-tarkov-border text-tarkov-accent border-l-2 border-tarkov-accent font-medium" data-target="dashboard">
                    <i class="fa-solid fa-chart-line w-6 text-center"></i> Dashboard
                </button>
                <button onclick="app.switchTab('market')" class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="market">
                    <i class="fa-solid fa-shop w-6 text-center"></i> Market & Craft
                </button>
                <button onclick="app.switchTab('tasks')" class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="tasks">
                    <i class="fa-solid fa-list-check w-6 text-center"></i> Task Database
                </button>
                <button onclick="app.switchTab('hideout')" class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="hideout">
                    <i class="fa-solid fa-dungeon w-6 text-center"></i> Hideout Manager
                </button>
                <button onclick="app.switchTab('gunsmith')" class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="gunsmith">
                    <i class="fa-solid fa-gun w-6 text-center"></i> Gunsmith
                </button>
                <button onclick="app.switchTab('ammo')" class="nav-btn-desktop w-full text-left px-3 py-2 rounded mb-1 hover:bg-white/5 text-gray-400 border-l-2 border-transparent" data-target="ammo">
                    <i class="fa-solid fa-bullseye w-6 text-center"></i> Ammo Table
                </button>
            </div>
            
            <div class="p-4 text-[10px] text-gray-600 text-center mt-auto">
                INTEGRATED SYSTEM<br>
                v0.42 (PvE + 3500LIMIT)
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 bg-tarkov-bg overflow-y-auto p-4 md:p-6 pb-32 md:pb-6 relative scroll-smooth" id="main-content">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="space-y-4 md:space-y-6 animate-fade-in">
                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                    <div class="glass-panel p-3 md:p-4 rounded">
                        <div class="text-gray-400 text-[10px] md:text-xs uppercase">DB Status</div>
                        <div class="text-sm md:text-base font-bold text-gray-500 mt-1" id="dash-status">Offline</div>
                    </div>
                    <div class="glass-panel p-3 md:p-4 rounded">
                        <div class="text-gray-400 text-[10px] md:text-xs uppercase">Live Tasks</div>
                        <div class="text-xl md:text-2xl font-bold text-white mt-1" id="dash-task-count">0</div>
                    </div>
                    <div class="glass-panel p-3 md:p-4 rounded">
                        <div class="text-gray-400 text-[10px] md:text-xs uppercase">Market Intel</div>
                        <div class="text-xl md:text-2xl font-bold text-tarkov-blue mt-1" id="dash-market-count">0</div>
                    </div>
                    <div class="glass-panel p-3 md:p-4 rounded">
                        <div class="text-gray-400 text-[10px] md:text-xs uppercase">Hideout</div>
                        <div class="text-xl md:text-2xl font-bold text-tarkov-green mt-1" id="dash-hideout-count">0%</div>
                    </div>
                </div>

                <!-- Shortcuts -->
                <div class="glass-panel p-4 md:p-6 rounded border border-dashed border-gray-700">
                    <h2 class="text-lg md:text-xl text-white mb-2"><i class="fa-solid fa-rocket mr-2"></i>Quick Access</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="app.switchTab('market')" class="flex items-center gap-3 bg-black/40 p-3 rounded hover:bg-white/5 border border-gray-800 hover:border-tarkov-blue transition text-left">
                            <div class="bg-tarkov-blue/20 p-2 rounded text-tarkov-blue"><i class="fa-solid fa-shop"></i></div>
                            <div>
                                <div class="text-sm font-bold text-gray-200">Market Monitor</div>
                                <div class="text-xs text-gray-500">市場価格・クラフト利益・バーター逆引き</div>
                            </div>
                        </button>
                        <button onclick="app.switchTab('hideout')" class="flex items-center gap-3 bg-black/40 p-3 rounded hover:bg-white/5 border border-gray-800 hover:border-tarkov-green transition text-left">
                            <div class="bg-tarkov-green/20 p-2 rounded text-tarkov-green"><i class="fa-solid fa-dungeon"></i></div>
                            <div>
                                <div class="text-sm font-bold text-gray-200">Hideout Manager</div>
                                <div class="text-xs text-gray-500">施設レベル管理・必要素材リスト</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW: MARKET MONITOR -->
            <div id="view-market" class="hidden space-y-4 animate-fade-in">
                <div class="glass-panel rounded overflow-hidden">
                    <div class="flex border-b border-gray-700 bg-black/20">
                        <div class="market-nav-tab active" onclick="app.switchMarketTab('items')" id="mt-items"><i class="fa-solid fa-tag mr-1"></i> MARKET</div>
                        <div class="market-nav-tab" onclick="app.switchMarketTab('crafts')" id="mt-crafts"><i class="fa-solid fa-hammer mr-1"></i> CRAFTS</div>
                    </div>
                    <div class="p-4">
                        <div id="subview-items">
                            <div class="mb-4 space-y-3">
                                <div class="w-full relative">
                                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                    <input type="text" id="market-search" placeholder="Search Item, Task or Barter..." class="w-full bg-black/40 border border-gray-600 pl-10 pr-4 py-2 rounded text-sm text-white focus:border-tarkov-blue outline-none">
                                </div>
                                
                                <!-- Phase 4: Smart Filters -->
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <button class="filter-toggle-btn" id="filter-req-task" onclick="app.toggleMarketFilter('task')">
                                        <i class="fa-solid fa-scroll"></i> Task Req
                                    </button>
                                    <button class="filter-toggle-btn" id="filter-req-hideout" onclick="app.toggleMarketFilter('hideout')">
                                        <i class="fa-solid fa-hammer"></i> Hideout Req
                                    </button>
                                    <button class="filter-toggle-btn" id="filter-req-barter" onclick="app.toggleMarketFilter('barter')">
                                        <i class="fa-solid fa-right-left"></i> Barter
                                    </button>
                                </div>

                                <div class="w-full overflow-x-auto scrollbar-hide pb-2">
                                    <div class="flex gap-2 min-w-max" id="market-category-filters">
                                        <button class="tarkov-btn active px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="all">Top Value</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="barter">Barter</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="keys">Keys</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="provisions">Food</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="ammo">Ammo</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="mods">Mods</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="container">Container</button>
                                        <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-type="wear">Gear</button>
                                    </div>
                                </div>
                            </div>
                            <div id="market-result-count" class="text-xs text-gray-500 mb-2 text-right">No Data - Loading...</div>
                            <div id="market-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3"></div>
                        </div>
                        <div id="subview-crafts" class="hidden">
                            <div class="mb-4 w-full overflow-x-auto scrollbar-hide pb-2">
                                <div class="flex gap-2 min-w-max" id="craft-filters">
                                    <button class="tarkov-btn active px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="all">ALL STATIONS</button>
                                    <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="ワークベンチ">ワークベンチ</button>
                                    <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="洗面所">洗面所</button>
                                    <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="医療ステーション">医療ステーション</button>
                                    <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="栄養ユニット">栄養ユニット</button>
                                    <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="インテリジェンスセンター">インテリジェンス</button>
                                    <button class="tarkov-btn px-3 py-1 text-xs rounded border border-gray-700 bg-gray-800 text-gray-400 hover:text-white transition" data-station="集水器">集水器</button>
                                </div>
                            </div>
                            <div id="craft-result-count" class="text-xs text-gray-500 mb-2 text-right">No Data - Loading...</div>
                            <div id="crafts-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: TASKS -->
            <div id="view-tasks" class="hidden space-y-4 animate-fade-in">
                <div class="flex flex-col gap-3 mb-4 sticky top-0 bg-tarkov-bg pt-2 pb-4 z-20 border-b border-gray-800">
                    <input type="text" id="task-search" placeholder="タスク名、報酬、詳細で検索..." class="w-full bg-tarkov-panel border border-tarkov-border px-4 py-3 rounded text-sm text-white focus:border-tarkov-accent focus:outline-none shadow-sm">
                    
                    <!-- Phase 4: Enhanced Filters including Map -->
                    <div class="grid grid-cols-2 gap-2">
                        <select id="filter-trader" class="bg-tarkov-panel border border-tarkov-border px-2 py-2 rounded text-sm text-gray-300">
                            <option value="all">全トレーダー</option>
                        </select>
                         <select id="filter-map" class="bg-tarkov-panel border border-tarkov-border px-2 py-2 rounded text-sm text-gray-300">
                            <option value="all">全マップ</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <select id="filter-type" class="bg-tarkov-panel border border-tarkov-border px-2 py-2 rounded text-sm text-gray-300">
                            <option value="all">全タイプ</option>
                            <option value="kappa">Kappa必須</option>
                            <option value="lightkeeper">Lightkeeper</option>
                        </select>
                        <select id="sort-by" class="bg-tarkov-panel border border-tarkov-border px-2 py-2 rounded text-sm text-gray-300">
                            <option value="minPlayerLevel">レベル順</option>
                            <option value="name">名前順</option>
                            <option value="trader">トレーダー順</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-2 mt-2">
                        <input type="checkbox" id="hide-completed" class="form-checkbox h-4 w-4 text-tarkov-accent rounded border-gray-600 bg-gray-700 focus:ring-tarkov-accent">
                        <label for="hide-completed" class="text-sm text-gray-300">完了済みを非表示</label>
                    </div>
                </div>
                <div id="task-list" class="grid grid-cols-1 gap-3 pb-4">
                    <div class="text-center text-gray-500 py-10">Loading tasks...</div>
                </div>
            </div>

            <!-- VIEW: GUNSMITH -->
            <div id="view-gunsmith" class="hidden space-y-4 animate-fade-in">
                <div class="bg-tarkov-panel border border-tarkov-border p-4 rounded shadow-lg">
                    <h2 class="text-sm font-mono text-tarkov-accent mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-screwdriver-wrench"></i> INTERACTIVE GUNSMITH
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2 space-y-3">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">BASE WEAPON</label>
                                <select id="gs-weapon" onchange="app.buildGun(this.value)" class="w-full bg-black border border-gray-600 p-2 text-white font-mono rounded focus:border-tarkov-accent outline-none">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            
                            <!-- Enhanced Auto-Build Controls -->
                            <div class="bg-black/20 p-3 rounded border border-gray-800 flex flex-col gap-2">
                                <div class="text-[10px] text-tarkov-accent font-bold uppercase tracking-wider flex justify-between items-center">
                                    <span>Target Stats</span>
                                    <button onclick="app.disassemble()" class="text-red-400 hover:text-red-300 text-[10px] uppercase font-bold flex items-center gap-1">
                                        <i class="fa-solid fa-trash-can"></i> Disassemble
                                    </button>
                                </div>
                                <div class="flex gap-2">
                                    <div class="flex-1">
                                        <input type="number" id="gs-target-ergo" placeholder="Ergo (Target)" class="w-full bg-black border border-gray-600 px-2 py-1 text-xs text-white rounded outline-none focus:border-tarkov-accent">
                                    </div>
                                    <div class="flex-1">
                                        <input type="number" id="gs-target-recoil" placeholder="Recoil (Max)" class="w-full bg-black border border-gray-600 px-2 py-1 text-xs text-white rounded outline-none focus:border-tarkov-accent">
                                    </div>
                                    <button onclick="app.autoAssemble()" class="bg-tarkov-accent text-black px-3 py-1 rounded text-xs font-bold hover:bg-tarkov-accentHover transition flex items-center gap-1">
                                        <i class="fa-solid fa-wand-magic-sparkles"></i> Auto
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="md:col-span-1 grid grid-cols-2 gap-2 text-center content-start">
                            <div class="bg-black/40 p-2 rounded border border-gray-800">
                                <div class="text-[10px] text-gray-500">ERGO</div>
                                <div id="gs-stat-ergo" class="text-xl font-bold text-gray-300">-</div>
                            </div>
                            <div class="bg-black/40 p-2 rounded border border-gray-800">
                                <div class="text-[10px] text-gray-500">RECOIL (V)</div>
                                <div id="gs-stat-recoil" class="text-xl font-bold text-gray-300">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Interactive Builder Area -->
                <div id="gs-builder-area" class="space-y-4 min-h-[300px]">
                    <div class="flex flex-col items-center justify-center text-gray-600 opacity-50 py-10">
                        <i class="fa-solid fa-crosshairs text-4xl mb-4"></i>
                        <div class="text-sm font-mono">Select a weapon to begin building</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: HIDEOUT -->
            <div id="view-hideout" class="hidden space-y-4 animate-fade-in">
                <div class="bg-tarkov-panel border border-tarkov-border p-4 rounded shadow-lg sticky top-0 z-20">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-bold text-gray-200"><i class="fa-solid fa-dungeon mr-2 text-tarkov-accent"></i>HIDEOUT STATUS</h2>
                        <span id="hideout-progress-text" class="text-xs text-tarkov-green font-mono">0% Completed</span>
                    </div>
                    <div class="w-full bg-black/50 rounded-full h-2 mb-1 border border-gray-800 overflow-hidden">
                        <div id="hideout-progress-bar" class="bg-tarkov-green h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="text-[10px] text-gray-500 text-right">Next Upgrade: Check items below</div>
                </div>

                <div id="hideout-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 pb-10">
                    <div class="text-center col-span-full py-10 text-gray-500"><span class="loader mr-2"></span>Loading Station Data...</div>
                </div>
            </div>

            <!-- VIEW: AMMO -->
            <div id="view-ammo" class="hidden space-y-4 animate-fade-in">
                <div class="glass-panel rounded overflow-hidden flex flex-col h-full">
                    <div class="bg-tarkov-panel px-4 py-3 border-b border-tarkov-border sticky top-0 z-10 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-gray-200">Meta Ammo Table</h3>
                        <span class="text-[10px] bg-red-900/30 text-red-400 px-2 py-0.5 rounded">High Pen First</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-400 whitespace-nowrap">
                            <thead class="text-xs text-gray-500 uppercase bg-black/40">
                                <tr>
                                    <th class="px-4 py-3">Caliber</th>
                                    <th class="px-4 py-3">Name</th>
                                    <th class="px-4 py-3">Dmg</th>
                                    <th class="px-4 py-3">Pen</th>
                                    <th class="px-4 py-3">Armor Dmg</th>
                                </tr>
                            </thead>
                            <tbody id="ammo-table-body" class="divide-y divide-gray-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Mobile Bottom Navigation (Fixed) -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-[#121212] border-t border-tarkov-border z-[100] pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.5)]">
        <div class="flex justify-around items-stretch h-14">
            <button onclick="app.switchTab('dashboard')" class="nav-btn-mobile flex-1 flex flex-col items-center justify-center gap-0.5 text-gray-500 mobile-nav-active" data-target="dashboard">
                <i class="fa-solid fa-chart-line text-base"></i><span class="text-[9px]">Dash</span>
            </button>
            <button onclick="app.switchTab('market')" class="nav-btn-mobile flex-1 flex flex-col items-center justify-center gap-0.5 text-gray-500" data-target="market">
                <i class="fa-solid fa-shop text-base"></i><span class="text-[9px]">Market</span>
            </button>
            <button onclick="app.switchTab('tasks')" class="nav-btn-mobile flex-1 flex flex-col items-center justify-center gap-0.5 text-gray-500" data-target="tasks">
                <i class="fa-solid fa-list-check text-base"></i><span class="text-[9px]">Tasks</span>
            </button>
            <button onclick="app.switchTab('gunsmith')" class="nav-btn-mobile flex-1 flex flex-col items-center justify-center gap-0.5 text-gray-500" data-target="gunsmith">
                <i class="fa-solid fa-gun text-base"></i><span class="text-[9px]">Gun</span>
            </button>
            <button onclick="app.switchTab('hideout')" class="nav-btn-mobile flex-1 flex flex-col items-center justify-center gap-0.5 text-gray-500" data-target="hideout">
                <i class="fa-solid fa-dungeon text-base"></i><span class="text-[9px]">Hideout</span>
            </button>
        </div>
    </nav>

    <!-- Toast -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-tarkov-panel border border-tarkov-accent text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition duration-300 z-[110] flex items-center gap-3 w-max max-w-[90%] pointer-events-none">
        <i class="fa-solid fa-info-circle text-tarkov-accent"></i><span id="toast-msg" class="text-sm font-medium">Notification</span>
    </div>

    <script>
        // --- APP CONTROLLER ---
        window.app = {
            data: { 
                tasks: [], 
                ammo: [], 
                traders: [],
                maps: [], // Phase 4
                weapons: [], 
                currentBuild: null,
                currentSlotCandidates: [],
                marketItems: [],
                itemPriceMap: new Map(),
                hideoutMap: new Map(),
                acquisitionMap: new Map(),
                crafts: [],
                hideoutStationsRaw: [],
                userHideoutLevels: {},
                marketConfig: {
                    category: 'all',
                    station: 'all',
                    tab: 'items',
                    // Phase 4: Smart Filters
                    filters: { task: false, hideout: false, barter: false }
                }
            },
            
            consts: {
                // REVERTED: Removed medicine/grenade from typeMapping
                typeMapping: { 'barter': ['barter'], 'keys': ['keys'], 'provisions': ['provisions'], 'ammo': ['ammo'], 'mods': ['mods', 'suppressor'], 'container': ['container'], 'wear': ['armor', 'helmet', 'glasses', 'headphones', 'rig', 'backpack'] },
                // REVERTED: Removed medicine/grenade from globalTypes
                globalTypes: ['barter', 'keys', 'ammo', 'provisions', 'mods', 'suppressor', 'container', 'armor', 'helmet', 'glasses', 'headphones', 'rig', 'backpack', 'gun'],
                sherpaIntelDB: {
                    "Delivery from the Past": {
                        desc: "Factoryは夜間推奨。Customsで回収後、一度スタッシュに戻りクエスト倉庫にアイテムを移すこと。",
                        tips: ["夜間Factoryは懐中電灯を持参", "Praporsの手紙は脱出不要"]
                    },
                    "Shooter Born in Heaven": {
                        desc: "距離制限撤廃。ボルトアクション必須。ヘッドショットのみ。",
                        tips: ["見晴らしの良い高台を確保", "サプレッサー推奨"]
                    },
                    "Setup": {
                        desc: "Piranha弾を使用し、Dormsへ突撃するのがメタ。",
                        tips: ["UshankaとScavVestを忘れない", "足音を聞いて待ち伏せ"]
                    },
                    "Gunsmith": {
                        desc: "耐久60以下の銃は納品不可。Scav武器は修理しても不可の場合が多い。",
                        tips: []
                    },
                    "Background Check": {
                        desc: "CustomsのConstructionエリア。トラックの運転席ドアの鍵が必要。",
                        tips: ["鍵はJacketから入手", "スナイパーSCAVに注意"]
                    }
                }
            },
            
            async init() {
                // Wait for DOM to be ready just in case
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.runInit());
                } else {
                    this.runInit();
                }
            },

            async runInit() {
                this.setupListeners();
                this.loadHideoutStatus();
                this.safeUpdateText('market-result-count', "Waiting for Sync...");
                // Auto Sync on Start
                this.fetchLiveStats();
                this.fetchWeaponData();
            },

            async fetchApiData(query) {
                try {
                    const res = await fetch('https://api.tarkov.dev/graphql', {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify({ query })
                    });
                    const json = await res.json();
                    
                    if (json.errors) {
                        console.error("API Returned Errors:", json.errors);
                        // DEBUG: Continue if partial data exists
                        if(!json.data) throw new Error(json.errors[0].message);
                    }
                    
                    if (json.data) return json.data;
                    throw new Error("No data in response");
                } catch (e) {
                    console.error("API Fetch Error:", e);
                    this.showToast("API Connection Failed: " + e.message);
                    this.safeUpdateHTML('dash-status', `<span class="text-red-500">ERROR</span>`);
                    return null;
                }
            },

            async fetchLiveStats() {
                const btn = document.getElementById('sync-btn');
                const original = btn ? btn.innerHTML : '';
                if(btn) {
                    btn.innerHTML = `<span class="loader"></span>`;
                    btn.disabled = true;
                }

                this.showToast("Syncing All Data...");
                this.safeUpdateHTML('dash-status', `<span class="text-yellow-500">INITIALIZING...</span>`);

                try {
                    const taskQuery = `{
                        tasks(limit: 1000, lang: ja) {
                            id name minPlayerLevel kappaRequired map { name } trader { name } wikiLink lightkeeperRequired
                            objectives { description }
                            startRewards { traderStanding { trader { name } standing } items { item { name shortName gridImageLink } count } }
                            finishRewards { traderStanding { trader { name } standing } items { item { name shortName gridImageLink } count } }
                        }
                        ammo(limit: 100, lang: en) { item { name } caliber damage penetrationPower armorDamage }
                    }`;
                    
                    const taskData = await this.fetchApiData(taskQuery);
                    if (taskData) {
                        this.data.tasks = taskData.tasks;
                        this.data.ammo = taskData.ammo.sort((a, b) => b.penetrationPower - a.penetrationPower);
                        this.processTaskMetaData(); // Phase 4: Process maps and traders
                        this.loadTaskCompletionStatus();
                        this.renderTasks();
                        this.renderAmmo();
                        this.safeUpdateText('dash-task-count', this.data.tasks.length);
                        // Fixed: dash-ammo-count element doesn't exist in HTML, ignoring or adding check
                        const ammoCountEl = document.getElementById('dash-ammo-count');
                        if(ammoCountEl) ammoCountEl.innerText = this.data.ammo.length;
                    }

                    await this.fetchMarketDataFull();

                    this.safeUpdateHTML('dash-status', `<span class="text-green-400">ONLINE (PvE)</span>`);
                    this.showToast("System Fully Synchronized (PvE)");

                } catch (e) {
                    console.error(e);
                    this.showToast("Partial Sync Fail");
                    this.safeUpdateHTML('dash-status', `<span class="text-red-500">SYNC ERROR</span>`);
                }
                
                if(btn) {
                    btn.innerHTML = original;
                    btn.disabled = false;
                }
            },

            async fetchMarketDataFull() {
                const hideoutQuery = `{ hideoutStations(lang: ja) { id name levels { level itemRequirements { count item { id name iconLink } } } } }`;
                const hideoutData = await this.fetchApiData(hideoutQuery);
                if (hideoutData) {
                    this.data.hideoutStationsRaw = hideoutData.hideoutStations;
                    this.data.hideoutMap.clear();
                    hideoutData.hideoutStations.forEach(s => s.levels.forEach(l => l.itemRequirements.forEach(r => {
                        if (!this.data.hideoutMap.has(r.item.id)) this.data.hideoutMap.set(r.item.id, []);
                        this.data.hideoutMap.get(r.item.id).push({ stationId: s.id, stationName: s.name, level: l.level, count: r.count });
                    })));
                    this.renderHideout();
                }

                const barterQuery = `{ barters(lang: ja) { trader { name } level requiredItems { count item { name iconLink } } rewardItems { item { id } } } }`;
                const barterData = await this.fetchApiData(barterQuery);
                if (barterData) {
                    this.data.acquisitionMap.clear();
                    barterData.barters.forEach(b => b.rewardItems.forEach(r => {
                        if (!this.data.acquisitionMap.has(r.item.id)) this.data.acquisitionMap.set(r.item.id, []);
                        this.data.acquisitionMap.get(r.item.id).push({ traderName: b.trader.name, level: b.level, ingredients: b.requiredItems });
                    }));
                }

                // UPDATED: Limit kept at 3500 as requested, types reverted
                const marketQuery = `{
                    items(gameMode: pve, limit: 3500, offset: 0, types: [${this.consts.globalTypes.join(', ')}], lang: ja) {
                        id name shortName avg24hPrice low24hPrice high24hPrice changeLast48hPercent wikiLink types iconLink gridImageLink description
                        sellFor { price source }
                        usedInTasks { name trader { name } wikiLink }
                        bartersFor { trader { name } level rewardItems { item { name } } }
                    }
                }`;
                const marketRes = await this.fetchApiData(marketQuery);
                if (marketRes) {
                    this.data.marketItems = marketRes.items.filter(i => i.avg24hPrice > 0).sort((a, b) => b.avg24hPrice - a.avg24hPrice);
                    this.data.itemPriceMap.clear();
                    this.data.marketItems.forEach(i => this.data.itemPriceMap.set(i.id, i.avg24hPrice));
                    this.safeUpdateText('dash-market-count', this.data.marketItems.length);
                }

                const craftQuery = `{
                    crafts(lang: ja) {
                        station { name } level duration
                        requiredItems { count item { id name iconLink } }
                        rewardItems { count item { id name iconLink } }
                    }
                }`;
                const craftRes = await this.fetchApiData(craftQuery);
                if (craftRes) {
                    this.data.crafts = craftRes.crafts.map(c => {
                        const rev = c.rewardItems.reduce((a, r) => a + ((this.data.itemPriceMap.get(r.item.id) || 0) * r.count), 0);
                        const cost = c.requiredItems.reduce((a, r) => a + ((this.data.itemPriceMap.get(r.item.id) || 0) * r.count), 0);
                        return { ...c, cost, profit: (rev * 0.9) - cost };
                    }).sort((a, b) => b.profit - a.profit);
                    // Fixed: element ID check
                    this.safeUpdateText('dash-craft-count', this.data.crafts.length);
                }

                this.renderMarket();
                this.renderCrafts();
            },

            // --- HELPER FUNCTIONS ---
            safeUpdateText(id, value) {
                const el = document.getElementById(id);
                if (el) el.innerText = value;
            },

            safeUpdateHTML(id, html) {
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            },

            switchMarketTab(tab) {
                this.data.marketConfig.tab = tab;
                document.getElementById('mt-items').className = `market-nav-tab ${tab === 'items' ? 'active' : ''}`;
                document.getElementById('mt-crafts').className = `market-nav-tab ${tab === 'crafts' ? 'active' : ''}`;
                document.getElementById('subview-items').classList.toggle('hidden', tab !== 'items');
                document.getElementById('subview-crafts').classList.toggle('hidden', tab !== 'crafts');
            },

            // --- PHASE 3: LOGIC HELPERS ---
            isTaskCompleted(taskName) {
                const task = this.data.tasks.find(t => t.name === taskName);
                return task ? !!task.completed : false;
            },

            isHideoutRequirementActive(itemId) {
                const requirements = this.data.hideoutMap.get(itemId);
                if (!requirements) return false;
                return requirements.some(req => {
                    const currentLevel = this.data.userHideoutLevels[req.stationId] || 0;
                    return req.level > currentLevel;
                });
            },
            
            // --- PHASE 4: SMART FILTER TOGGLES ---
            toggleMarketFilter(type) {
                this.data.marketConfig.filters[type] = !this.data.marketConfig.filters[type];
                // Update Button Visuals
                const btn = document.getElementById(`filter-req-${type}`);
                if(btn) btn.classList.toggle('active', this.data.marketConfig.filters[type]);
                this.renderMarket();
            },

            // --- RENDERERS ---
            renderMarket() {
                const searchInput = document.getElementById('market-search');
                const search = searchInput ? searchInput.value.toLowerCase().trim() : '';
                const cat = this.data.marketConfig.category;
                const filters = this.data.marketConfig.filters; // Phase 4
                
                let results = this.data.marketItems;

                // 1. Search Filter
                if (search.length > 0) {
                    results = results.filter(i => i.name.toLowerCase().includes(search) || (i.shortName && i.shortName.toLowerCase().includes(search)));
                } else if (cat !== 'all') {
                    // 2. Category Filter (Only if search is empty)
                    const types = this.consts.typeMapping[cat];
                    if (types) results = results.filter(i => i.types.some(t => types.includes(t)));
                }
                
                // 3. Smart Filters (Phase 4: AND Logic)
                if (filters.task) {
                    results = results.filter(i => i.usedInTasks && i.usedInTasks.length > 0);
                }
                if (filters.hideout) {
                    results = results.filter(i => this.data.hideoutMap.has(i.id));
                }
                if (filters.barter) {
                    results = results.filter(i => i.bartersFor && i.bartersFor.length > 0);
                }

                const grid = document.getElementById('market-grid');
                if(!grid) return;
                grid.innerHTML = '';
                const display = results.slice(0, 100);
                this.safeUpdateText('market-result-count', `${results.length} RESULTS`);

                if (display.length === 0) { grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">NO DATA FOUND</div>'; return; }

                display.forEach(item => {
                    const priceFmt = item.avg24hPrice.toLocaleString();
                    const lowPrice = item.low24hPrice ? item.low24hPrice.toLocaleString() : '---';
                    const highPrice = item.high24hPrice ? item.high24hPrice.toLocaleString() : '---';

                    const tasks = item.usedInTasks || [];
                    const hideouts = this.data.hideoutMap.get(item.id) || [];
                    const barters = item.bartersFor || [];
                    const acquisition = this.data.acquisitionMap.get(item.id) || [];

                    const isTask = tasks.length > 0;
                    const isHideout = hideouts.length > 0;
                    const isBarter = barters.length > 0;
                    const hasRecipe = acquisition.length > 0;

                    const isTaskActive = isTask && tasks.some(t => !this.isTaskCompleted(t.name));
                    const isHideoutActive = isHideout && this.isHideoutRequirementActive(item.id);

                    let badges = '';
                    if(isTask) {
                        const css = isTaskActive ? 'req-quest' : 'req-done';
                        badges += `<span class="req-badge ${css}"><i class="fa-solid fa-scroll"></i> TASK</span>`;
                    }
                    if(isHideout) {
                        const css = isHideoutActive ? 'req-hideout' : 'req-done';
                        badges += `<span class="req-badge ${css}"><i class="fa-solid fa-hammer"></i> HIDEOUT</span>`;
                    }
                    if(isBarter) badges += `<span class="req-badge req-barter"><i class="fa-solid fa-right-left"></i> BARTER</span>`;

                    let details = '';
                    if(hasRecipe) {
                        details += `<h5 class="text-tarkov-blue font-bold mb-1 mt-1 text-xs"><i class="fa-solid fa-cart-shopping"></i> ACQUISITION</h5><div class="space-y-2 mb-3">`;
                        acquisition.forEach(d => {
                            const ings = d.ingredients.map(r => `<span class="inline-block bg-[#1a1a1a] rounded px-1 border border-[#333] mr-1 mb-1 text-[10px] text-gray-300">${r.item.name} x${r.count}</span>`).join('');
                            details += `<div class="bg-[#111] p-2 rounded border border-[#333]"><div class="text-[10px] text-gray-500 mb-1">TRADER: ${d.traderName} (LL${d.level})</div><div class="flex flex-wrap">${ings}</div></div>`;
                        });
                        details += `</div>`;
                    }
                    if(isTask) {
                        details += `<h5 class="text-tarkov-gold font-bold mt-2 mb-1 text-xs"><i class="fa-solid fa-scroll"></i> TASKS</h5><ul class="list-none space-y-1 mb-2">`;
                        tasks.forEach(t => {
                            const done = this.isTaskCompleted(t.name);
                            const doneStyle = done ? 'text-gray-600 line-through' : 'hover:text-tarkov-green underline decoration-dotted';
                            details += `
                            <li class="flex justify-between border-b border-gray-800 pb-1 text-[10px]">
                                <span class="truncate pr-2"><a href="${t.wikiLink}" target="_blank" class="${doneStyle}" onclick="event.stopPropagation()">${t.name}</a> <span class="text-gray-500">(${t.trader.name})</span></span>
                                <span class="font-mono text-gray-400">REQ</span>
                            </li>`;
                        });
                        details += `</ul>`;
                    }
                    if (isHideout) {
                        details += `<h5 class="text-tarkov-green font-bold mt-2 mb-1 text-xs"><i class="fa-solid fa-hammer"></i> HIDEOUT</h5><ul class="list-none space-y-1 mb-2">`;
                        hideouts.forEach(h => {
                            const curLvl = this.data.userHideoutLevels[h.stationId] || 0;
                            const needed = h.level > curLvl;
                            const style = needed ? 'text-gray-300' : 'text-gray-600 line-through';
                            details += `<li class="flex justify-between border-b border-gray-800 pb-1 text-[10px]"><span class="truncate pr-2 ${style}">${h.stationName} (Lv${h.level})</span><span class="font-mono text-gray-400">x${h.count}</span></li>`;
                        });
                        details += `</ul>`;
                    }
                    if (isBarter) {
                        details += `<h5 class="text-purple-400 font-bold mt-2 mb-1 text-xs"><i class="fa-solid fa-right-left"></i> USED IN BARTER</h5><ul class="list-none space-y-1">`;
                        barters.forEach(b => {
                            const rNames = b.rewardItems.map(ri => ri.item.name).join(', ');
                            details += `<li class="flex justify-between border-b border-gray-800 pb-1 text-[10px]"><span class="truncate pr-2 text-gray-300">${rNames}</span><span class="font-mono text-gray-400">${b.trader.name} LL${b.level}</span></li>`;
                        });
                        details += `</ul>`;
                    }
                    if (!details && !hasRecipe) details = `<div class="p-2 bg-gray-900/50 rounded text-gray-500 italic text-center border border-gray-800 text-xs">No strategic usage found.</div>`;

                    const card = document.createElement('div');
                    card.className = 'market-card tarkov-panel rounded p-3 flex flex-col relative group touch-manipulation cursor-pointer border border-tarkov-border hover:border-tarkov-blue transition';
                    card.onclick = function() { this.classList.toggle('expanded'); };
                    card.innerHTML = `
                        <div class="flex gap-3 mb-2 items-center">
                            <div class="w-12 h-12 bg-[#111] border border-[#333] flex items-center justify-center rounded shrink-0 overflow-hidden relative">
                                <img src="${item.iconLink}" alt="" class="w-10 h-10 object-contain absolute" onerror="this.style.display='none'">
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="font-bold text-tarkov-gold text-sm leading-tight truncate">${item.name}</h3>
                                <div class="mt-1">${badges}</div>
                            </div>
                            <div class="text-right pl-2 shrink-0">
                                <span class="text-[10px] text-gray-500 block">AVG PRICE</span>
                                <span class="text-sm font-bold font-mono text-tarkov-blue">₽${priceFmt}</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-xs pt-2 border-t border-[#333]">
                            <span class="${item.changeLast48hPercent >= 0 ? 'text-tarkov-green' : 'text-tarkov-red'}"><i class="fa-solid ${item.changeLast48hPercent >= 0 ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down'}"></i> ${item.changeLast48hPercent}%</span>
                            <span class="text-gray-500 text-[10px] uppercase tracking-wider"><i class="fa-solid fa-chevron-down mr-1"></i>Intel</span>
                        </div>
                        <div class="detail-section text-xs text-gray-400">
                            <div class="grid grid-cols-2 gap-2 mb-3 bg-black/40 p-2 rounded border border-gray-800 text-center">
                                <div><span class="text-[10px] text-gray-500 block">LOW (24h)</span><span class="text-gray-300 font-mono">₽${lowPrice}</span></div>
                                <div><span class="text-[10px] text-gray-500 block">HIGH (24h)</span><span class="text-gray-300 font-mono">₽${highPrice}</span></div>
                            </div>
                            <div class="flex flex-col gap-3">
                                <div class="bg-[#050505] border border-[#333] rounded p-2">${details}</div>
                                <div class="bg-[#111] border border-[#333] rounded p-2 flex justify-center"><img src="${item.gridImageLink || item.iconLink}" class="max-h-32 object-contain" alt="Detailed View" onerror="this.style.display='none'"></div>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            },

            renderCrafts() {
                const grid = document.getElementById('crafts-grid');
                if(!grid) return;
                grid.innerHTML = '';
                const st = this.data.marketConfig.station;
                const results = st === 'all' ? this.data.crafts : this.data.crafts.filter(c => c.station.name.includes(st));
                this.safeUpdateText('craft-result-count', `${results.length} RECIPES`);

                if(results.length === 0) { grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">NO CRAFTS</div>'; return; }

                results.slice(0, 50).forEach(craft => {
                    const profitFmt = Math.round(craft.profit).toLocaleString();
                    const costFmt = Math.round(craft.cost).toLocaleString();
                    const rewards = craft.rewardItems.map(r => `<div class="flex items-center gap-2 mb-1"><img src="${r.item.iconLink}" class="w-6 h-6 bg-[#222] rounded" onerror="this.style.display='none'"><span class="text-tarkov-gold font-bold text-xs truncate">${r.item.name} x${r.count}</span></div>`).join('');
                    const reqs = craft.requiredItems.map(r => `<div class="flex justify-between text-[10px] text-gray-400 border-b border-[#222] py-1"><span>${r.item.name}</span><span>x${r.count}</span></div>`).join('');

                    const card = document.createElement('div');
                    card.className = 'tarkov-panel rounded p-3 flex flex-col relative border-l-4 ' + (craft.profit >= 0 ? 'border-l-green-600' : 'border-l-red-600');
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">${craft.station.name} Lv${craft.level}</span>
                            <div class="text-right">
                                <span class="block text-xs text-gray-500">PROFIT</span>
                                <span class="font-bold font-mono text-lg ${craft.profit >= 0 ? 'profit-pos' : 'profit-neg'}">₽${profitFmt}</span>
                            </div>
                        </div>
                        <div class="mb-3">${rewards}</div>
                        <div class="bg-[#111] p-2 rounded border border-[#333]">
                            <div class="flex justify-between text-[10px] text-gray-500 mb-1 border-b border-[#333] pb-1"><span>INGREDIENTS</span><span>COST: ₽${costFmt}</span></div>
                            <div class="max-h-24 overflow-y-auto custom-scrollbar">${reqs}</div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            },

            // --- HIDEOUT MANAGER ---
            renderHideout() {
                const grid = document.getElementById('hideout-grid');
                if(!grid) return;
                
                const stations = this.data.hideoutStationsRaw;
                if (!stations || stations.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">Waiting for Data...</div>';
                    return;
                }

                stations.sort((a, b) => a.name.localeCompare(b.name));

                grid.innerHTML = '';
                
                let totalStations = stations.length;
                let maxLevelSum = 0;
                let currentLevelSum = 0;

                stations.forEach(station => {
                    const savedLevel = this.data.userHideoutLevels[station.id] || 0;
                    const maxLevel = Math.max(...station.levels.map(l => l.level));
                    
                    maxLevelSum += maxLevel;
                    currentLevelSum += savedLevel;
                    
                    const nextLevel = savedLevel + 1;
                    const nextLevelData = station.levels.find(l => l.level === nextLevel);
                    const isMaxed = savedLevel >= maxLevel;

                    let reqHtml = '';
                    if (isMaxed) {
                        reqHtml = `<div class="text-tarkov-green text-xs font-bold text-center py-4 bg-green-900/10 rounded border border-green-900/30">MAX LEVEL REACHED</div>`;
                    } else if (nextLevelData) {
                        const items = nextLevelData.itemRequirements.map(req => `
                            <div class="flex items-center gap-2 bg-[#111] p-1.5 rounded border border-[#333]">
                                <img src="${req.item.iconLink}" class="w-6 h-6 object-contain bg-[#222] rounded" onerror="this.style.display='none'">
                                <div class="min-w-0 flex-1">
                                    <div class="text-[10px] text-gray-300 truncate">${req.item.name}</div>
                                    <div class="text-[9px] text-gray-500">x${req.count}</div>
                                </div>
                            </div>
                        `).join('');
                        reqHtml = `<div class="space-y-1 mt-2 mb-1"><div class="text-[9px] text-gray-500 uppercase">Requirements for Lv${nextLevel}</div><div class="grid grid-cols-2 gap-1">${items}</div></div>`;
                    } else {
                        reqHtml = `<div class="text-gray-500 text-xs text-center py-4">Data not available</div>`;
                    }

                    const card = document.createElement('div');
                    card.className = `tarkov-panel rounded p-3 border ${isMaxed ? 'border-tarkov-green/30' : 'border-tarkov-border'} flex flex-col`;
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-sm ${isMaxed ? 'text-tarkov-green' : 'text-gray-200'} truncate pr-2">${station.name}</h3>
                            <div class="flex items-center gap-1 bg-[#111] rounded p-1 border border-[#333]">
                                <button class="hideout-level-btn" onclick="app.updateHideoutLevel('${station.id}', -1)" ${savedLevel <= 0 ? 'disabled' : ''}>-</button>
                                <span class="w-8 text-center font-mono font-bold ${isMaxed ? 'text-tarkov-green' : 'text-white'}">${savedLevel}</span>
                                <button class="hideout-level-btn" onclick="app.updateHideoutLevel('${station.id}', 1)" ${isMaxed ? 'disabled' : ''}>+</button>
                            </div>
                        </div>
                        <div class="flex-1">${reqHtml}</div>
                    `;
                    grid.appendChild(card);
                });

                // Update Progress Bar
                const progress = totalStations > 0 ? Math.round((currentLevelSum / maxLevelSum) * 100) : 0;
                this.safeUpdateHTML('dash-hideout-count', `${progress}%`);
                document.getElementById('hideout-progress-text').innerText = `${progress}% Completed`;
                document.getElementById('hideout-progress-bar').style.width = `${progress}%`;
            },

            updateHideoutLevel(stationId, change) {
                const stations = this.data.hideoutStationsRaw;
                const station = stations.find(s => s.id === stationId);
                if (!station) return;

                const maxLevel = Math.max(...station.levels.map(l => l.level));
                let current = this.data.userHideoutLevels[stationId] || 0;
                let next = current + change;

                if (next < 0) next = 0;
                if (next > maxLevel) next = maxLevel;

                this.data.userHideoutLevels[stationId] = next;
                this.saveHideoutStatus();
                this.renderHideout();
                // Phase 3: Update Market view to reflect new requirements
                if(!document.getElementById('view-market').classList.contains('hidden')) {
                    this.renderMarket();
                }
            },

            loadHideoutStatus() {
                const s = localStorage.getItem('userHideoutLevels');
                if (s) {
                    try {
                        this.data.userHideoutLevels = JSON.parse(s);
                    } catch (e) {
                        console.error("Failed to load hideout levels", e);
                        this.data.userHideoutLevels = {};
                    }
                }
            },

            saveHideoutStatus() {
                localStorage.setItem('userHideoutLevels', JSON.stringify(this.data.userHideoutLevels));
            },


            // --- GUNSMITH MODULE ---
            async fetchWeaponData() {
                const query = `{ items(types: [gun], lang: ja) { id name shortName types } }`;
                const data = await this.fetchApiData(query);
                if (data && data.items) {
                    // Debug Fix: Use name for sort to avoid shortName issues, also remove duplicates
                    this.data.weapons = data.items.filter((v,i,a)=>a.findIndex(t=>(t.id === v.id))===i).sort((a, b) => a.name.localeCompare(b.name));
                    this.setupGunsmith();
                }
            },

            setupGunsmith() {
                const select = document.getElementById('gs-weapon');
                if(!select) return;
                if (this.data.weapons.length === 0) { select.innerHTML = `<option value="">Waiting for Sync...</option>`; return; }
                const groups = this.data.weapons.reduce((g, w) => {
                    // Debug Fix: Handle shortNames that don't have spaces or are weird
                    const fam = w.shortName ? w.shortName.split(' ')[0] : 'Other';
                    if (!g[fam]) g[fam] = [];
                    g[fam].push(w);
                    return g;
                }, {});
                let opts = `<option value="">Select Weapon...</option>`;
                for (const gn in groups) {
                    opts += `<optgroup label="${gn}">`;
                    groups[gn].forEach(w => opts += `<option value="${w.id}">${w.name}</option>`); 
                    opts += `</optgroup>`;
                }
                select.innerHTML = opts;
            },

            async buildGun(id) {
                if (!id) return;
                
                this.safeUpdateHTML('gs-builder-area', '<div class="flex justify-center py-10 opacity-50"><div class="loader"></div></div>');
                this.safeUpdateText('gs-stat-ergo', '-');
                this.safeUpdateText('gs-stat-recoil', '-');

                // Fetch detailed weapon info including properties and slots with Japanese Names
                const query = `{
                    items(ids: ["${id}"], lang: ja) {
                        id name shortName description basePrice width height inspectImageLink gridImageLink
                        properties {
                            ... on ItemPropertiesWeapon {
                                ergonomics recoilVertical recoilHorizontal fireRate caliber
                                defaultPreset { inspectImageLink gridImageLink }
                                slots {
                                    name
                                    filters { allowedItems { id name shortName gridImageLink properties { ... on ItemPropertiesWeaponMod { ergonomics recoilModifier } } } }
                                }
                            }
                        }
                    }
                }`;

                const data = await this.fetchApiData(query);
                if (data && data.items && data.items.length > 0) {
                    const item = data.items[0];
                    this.data.currentBuild = {
                        baseWeapon: item,
                        attachedParts: []
                    };
                    this.renderGunBuilder(this.data.currentBuild);
                } else {
                    this.showToast("Failed to load weapon details");
                    this.safeUpdateHTML('gs-builder-area', '<div class="text-center text-red-500 py-10">Error loading weapon data</div>');
                }
            },

            disassemble() {
                if (!this.data.currentBuild) {
                    this.showToast("Select a weapon first");
                    return;
                }
                this.data.currentBuild.attachedParts = [];
                this.renderGunBuilder(this.data.currentBuild);
                this.showToast("Weapon Disassembled");
            },

            autoAssemble() {
                if (!this.data.currentBuild) {
                    this.showToast("Select a weapon first");
                    return;
                }
                
                const targetErgo = parseFloat(document.getElementById('gs-target-ergo').value);
                const hasTarget = !isNaN(targetErgo);
                
                this.showToast(hasTarget ? `Targeting Ergo ~${targetErgo}...` : "Auto-Building (Max Ergo)...");
                
                const baseWeapon = this.data.currentBuild.baseWeapon;
                const slots = baseWeapon.properties?.slots || [];
                
                this.data.currentBuild.attachedParts = [];

                // Helper: Get candidate items for a slot
                const getItems = (slot) => {
                    // DEBUG FIX: Handle empty filters array or missing allowedItems
                    if (!slot.filters) return [];
                    if (Array.isArray(slot.filters)) {
                        return slot.filters[0] && slot.filters[0].allowedItems ? slot.filters[0].allowedItems : [];
                    }
                    if (slot.filters.allowedItems) return slot.filters.allowedItems;
                    return [];
                };

                if (hasTarget) {
                    // --- Target Approximation Mode ---
                    
                    // 1. Prepare candidates for each slot, sorted by Ergo descending
                    const slotCandidates = slots.map(slot => {
                        const items = getItems(slot);
                        if (!items || items.length === 0) return { slotName: slot.name, items: [] };
                        return {
                            slotName: slot.name,
                            items: items.sort((a, b) => (b.properties?.ergonomics || 0) - (a.properties?.ergonomics || 0))
                        };
                    });

                    // 2. Start with MAX Ergo config
                    const currentParts = slotCandidates.map(sc => sc.items[0]).filter(p => p); 
                    
                    const calcErgo = (parts) => {
                        let e = baseWeapon.properties?.ergonomics || 0;
                        parts.forEach(p => e += (p.properties?.ergonomics || 0));
                        return e;
                    };

                    let currentTotal = calcErgo(currentParts);

                    // 3. Downgrade loop to approach target
                    let improved = true;
                    // Guard loop
                    let loops = 0;
                    while (improved && currentTotal > targetErgo && loops < 50) {
                        improved = false;
                        loops++;
                        let bestSwap = null;
                        let minDiff = Math.abs(currentTotal - targetErgo);

                        for (let i = 0; i < slotCandidates.length; i++) {
                            const sc = slotCandidates[i];
                            const currentPart = currentParts.find(p => sc.items.includes(p)); 
                            if (!currentPart) continue; 

                            const currentIndex = sc.items.indexOf(currentPart);
                            if (currentIndex + 1 < sc.items.length) {
                                const nextPart = sc.items[currentIndex + 1];
                                const ergoDiff = (currentPart.properties?.ergonomics || 0) - (nextPart.properties?.ergonomics || 0);
                                const newTotal = currentTotal - ergoDiff;
                                const diff = Math.abs(newTotal - targetErgo);

                                if (diff < minDiff) {
                                    minDiff = diff;
                                    bestSwap = { index: i, oldPart: currentPart, newPart: nextPart, newTotal: newTotal };
                                }
                            }
                        }

                        if (bestSwap) {
                            const oldIdx = currentParts.indexOf(bestSwap.oldPart);
                            if (oldIdx > -1) {
                                currentParts[oldIdx] = bestSwap.newPart;
                                currentTotal = bestSwap.newTotal;
                                improved = true;
                            }
                        }
                    }

                    // 4. Commit
                    currentParts.forEach(p => {
                        const candidate = slotCandidates.find(sc => sc.items.includes(p));
                        if(candidate) {
                            this.data.currentBuild.attachedParts.push({ slotName: candidate.slotName, part: p });
                        }
                    });

                } else {
                    // --- Original Max Ergo Mode ---
                    slots.forEach(slot => {
                        let items = getItems(slot);
                        if (!items || items.length === 0) return;
                        
                        // Sort by Ergo Descending
                        items.sort((a, b) => (b.properties?.ergonomics || 0) - (a.properties?.ergonomics || 0));
                        
                        const bestPart = items[0];
                        if (bestPart) {
                            this.data.currentBuild.attachedParts.push({ slotName: slot.name, part: bestPart });
                        }
                    });
                }
                
                this.renderGunBuilder(this.data.currentBuild);
                this.showToast("Assembly Complete");
            },

            renderGunBuilder(build) {
                const item = build.baseWeapon;
                const props = item.properties || {};
                
                let ergo = props.ergonomics || 0;
                let recoil = props.recoilVertical || 0;
                let modSum = 0;
                
                build.attachedParts.forEach(ap => {
                    const pProps = ap.part.properties || {};
                    if(pProps.ergonomics) ergo += pProps.ergonomics;
                    if(pProps.recoilModifier) modSum += pProps.recoilModifier;
                });
                const finalRecoil = recoil * (1 + (modSum / 100));

                this.safeUpdateText('gs-stat-ergo', Math.round(ergo));
                this.safeUpdateText('gs-stat-recoil', Math.round(finalRecoil));

                let imgUrl = item.properties?.defaultPreset?.inspectImageLink || item.inspectImageLink || item.gridImageLink || '';
                let caliber = props.caliber ? props.caliber.replace('Caliber', '') : 'Unknown';

                let html = `
                    <div class="glass-panel p-4 md:p-6 rounded animate-fade-in relative overflow-hidden group">
                        <div class="absolute -top-6 -right-6 text-9xl font-bold text-white opacity-[0.03] select-none pointer-events-none transition-transform group-hover:scale-110 duration-700">${item.shortName}</div>
                        <div class="flex flex-col md:flex-row gap-6 items-start relative z-10">
                            <div class="w-full md:w-5/12">
                                <div class="bg-black/20 rounded-lg p-6 border border-gray-800 flex items-center justify-center min-h-[200px] relative">
                                    <img src="${imgUrl}" class="w-full h-auto object-contain drop-shadow-2xl" onerror="this.src='https://via.placeholder.com/200x100?text=No+Image'">
                                </div>
                                <div class="mt-3 flex justify-between text-[10px] text-gray-500 font-mono px-1">
                                    <span>${item.width}x${item.height} CELLS</span>
                                    <span>${caliber}</span>
                                </div>
                            </div>
                            <div class="w-full md:w-7/12 space-y-5">
                                <div>
                                    <h3 class="text-xl md:text-2xl font-bold text-white leading-tight font-mono">${item.name}</h3>
                                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4">
                                        <div class="bg-[#0a0a0a] p-2 rounded border border-gray-800"><div class="text-[9px] text-gray-500">RPM</div><div class="text-tarkov-green font-mono font-bold">${props.fireRate || '-'}</div></div>
                                        <div class="bg-[#0a0a0a] p-2 rounded border border-gray-800"><div class="text-[9px] text-gray-500">H. RECOIL</div><div class="text-gray-300 font-mono">${props.recoilHorizontal || '-'}</div></div>
                                    </div>
                                </div>
                                
                                <div class="border-t border-gray-800 pt-4">
                                    <h4 class="text-xs text-gray-500 uppercase font-bold mb-2">Available Slots</h4>
                                    <div class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                                        ${(props.slots || []).map(slot => {
                                            const attached = build.attachedParts.find(p => p.slotName === slot.name);
                                            return `
                                            <div class="bg-black/40 p-2 rounded border border-gray-800 flex justify-between items-center group/slot">
                                                <span class="text-xs text-gray-400 font-mono">${slot.name}</span>
                                                <div class="flex items-center gap-2">
                                                    ${attached ? 
                                                        `<span class="text-tarkov-accent text-xs truncate max-w-[150px]" title="${attached.part.name}">${attached.part.name}</span>
                                                         <button class="text-red-500 hover:text-red-400" onclick="app.removePart('${slot.name}')"><i class="fa-solid fa-times"></i></button>` 
                                                        : 
                                                        `<button class="text-xs bg-gray-800 hover:bg-gray-700 px-2 py-1 rounded text-gray-300" onclick='app.showParts("${slot.name}")'>Select Part</button>`
                                                    }
                                                </div>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="gs-part-selector" class="hidden mt-4 border-t border-gray-700 pt-4 animate-fade-in scroll-mt-20">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-xs text-tarkov-accent uppercase font-bold">Select Part</h4>
                                <button onclick="document.getElementById('gs-part-selector').classList.add('hidden')" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                            </div>
                            <div id="gs-part-list" class="grid grid-cols-2 sm:grid-cols-4 gap-2 max-h-60 overflow-y-auto custom-scrollbar"></div>
                        </div>
                    </div>
                `;
                this.safeUpdateHTML('gs-builder-area', html);
            },

            showParts(slotName) {
                const container = document.getElementById('gs-part-selector');
                const list = document.getElementById('gs-part-list');
                const title = container.querySelector('h4'); 
                
                container.classList.remove('hidden');
                
                const slot = this.data.currentBuild.baseWeapon.properties.slots.find(s => s.name === slotName);
                
                if(title) title.innerText = `Select Part: ${slotName}`;

                // Robust check for filters being array or object
                let items = [];
                if (slot && slot.filters) {
                    if (Array.isArray(slot.filters)) {
                         // Standard array behavior
                         items = slot.filters[0] ? slot.filters[0].allowedItems : [];
                    } else if (slot.filters.allowedItems) {
                         // Object behavior (API quirk handling)
                         items = slot.filters.allowedItems;
                    }
                }

                if(!items || items.length === 0) {
                    list.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">No compatible parts found for this slot.</div>';
                    setTimeout(() => container.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
                    return;
                }

                this.data.currentSlotCandidates = items;

                // Use 'name' instead of 'shortName' for Japanese display
                list.innerHTML = items.map(p => `
                    <div class="bg-[#0f0f0f] border border-gray-800 p-2 rounded hover:border-tarkov-accent cursor-pointer flex flex-col items-center gap-1 group transition-all hover:bg-white/5" onclick='app.attachPart("${slotName}", "${p.id}")' title="${p.name}">
                        <img src="${p.gridImageLink}" class="w-12 h-12 object-contain group-hover:scale-110 transition" loading="lazy" onerror="this.style.opacity=0.3">
                        <span class="text-[10px] text-gray-400 text-center truncate w-full group-hover:text-white">${p.name}</span>
                    </div>
                `).join('');
                
                setTimeout(() => {
                    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            },

            attachPart(slotName, partId) {
                const part = this.data.currentSlotCandidates.find(p => p.id === partId);
                if (!part) return;

                this.data.currentBuild.attachedParts = this.data.currentBuild.attachedParts.filter(p => p.slotName !== slotName);
                this.data.currentBuild.attachedParts.push({ slotName, part });
                this.renderGunBuilder(this.data.currentBuild);
            },

            removePart(slotName) {
                this.data.currentBuild.attachedParts = this.data.currentBuild.attachedParts.filter(p => p.slotName !== slotName);
                this.renderGunBuilder(this.data.currentBuild);
            },

            // --- GENERAL & HELPERS ---
            processTaskMetaData() {
                // Phase 4: Extract Maps and Traders
                const traderSet = new Set();
                const mapSet = new Set();
                
                this.data.tasks.forEach(t => {
                    if(t.trader?.name) traderSet.add(t.trader.name);
                    if(t.map?.name) mapSet.add(t.map.name);
                });

                // Update Trader Filter
                const trSelect = document.getElementById('filter-trader');
                if(trSelect) trSelect.innerHTML = '<option value="all">全トレーダー</option>' + Array.from(traderSet).sort().map(t => `<option value="${t}">${t}</option>`).join('');

                // Update Map Filter (Phase 4)
                const mapSelect = document.getElementById('filter-map');
                if(mapSelect) mapSelect.innerHTML = '<option value="all">全マップ</option>' + Array.from(mapSet).sort().map(m => `<option value="${m}">${m}</option>`).join('');
            },

            // --- RENDERERS ---
            render() {
                this.renderTasks();
                this.renderAmmo();
            },

            renderTasks() {
                const searchInput = document.getElementById('task-search');
                const search = searchInput ? searchInput.value.toLowerCase() : '';
                const traderEl = document.getElementById('filter-trader');
                const trader = traderEl ? traderEl.value : 'all';
                const mapEl = document.getElementById('filter-map');
                const map = mapEl ? mapEl.value : 'all'; // Phase 4
                const typeEl = document.getElementById('filter-type');
                const type = typeEl ? typeEl.value : 'all';
                const list = document.getElementById('task-list');
                const hideEl = document.getElementById('hide-completed');
                const hideCompleted = hideEl ? hideEl.checked : false;
                
                // Sorting Logic
                const sortEl = document.getElementById('sort-by');
                const sortBy = sortEl ? sortEl.value : 'minPlayerLevel';

                let filtered = this.data.tasks.filter(t => {
                    // Phase 4: Expanded Search (Objectives & Rewards)
                    // DEBUG FIX: Added checks for null values before toLowerCase
                    const searchTargets = [
                        t.name,
                        t.map?.name || '',
                        t.trader?.name || '',
                        ...(t.objectives?.map(o => o.description) || []),
                        ...(t.startRewards?.items?.map(i => i.item.name) || []),
                        ...(t.finishRewards?.items?.map(i => i.item.name) || [])
                    ].map(s => (s || '').toLowerCase());
                    
                    const mSearch = searchTargets.some(s => s.includes(search));
                    
                    const mTrader = trader === 'all' || t.trader?.name === trader;
                    const mMap = map === 'all' || t.map?.name === map; // Phase 4
                    let mType = true;
                    if (type === 'kappa') mType = t.kappaRequired;
                    if (type === 'lightkeeper') mType = t.lightkeeperRequired;
                    
                    return mSearch && mTrader && mMap && mType;
                });

                if (hideCompleted) filtered = filtered.filter(t => !t.completed);
                
                // Sort
                filtered.sort((a, b) => {
                    let valA, valB;
                    if (sortBy === 'trader') {
                        valA = a.trader?.name || ''; valB = b.trader?.name || '';
                    } else if (sortBy === 'name') {
                        valA = a.name; valB = b.name;
                    } else { // minPlayerLevel
                        valA = a.minPlayerLevel || 0; valB = b.minPlayerLevel || 0;
                    }
                    
                    if (typeof valA === 'string') return valA.localeCompare(valB);
                    return valA - valB;
                });

                if (filtered.length === 0) { list.innerHTML = `<div class="text-center text-gray-500 py-10">No tasks match your criteria.</div>`; return; }

                list.innerHTML = filtered.slice(0, search ? 100 : 50).map(t => {
                    // Logic to build detailed view
                    let rewardsHtml = '';
                    const processRew = (rew, type) => {
                        if(!rew) return '';
                        let html = '';
                        if(rew.traderStanding) rew.traderStanding.forEach(r => html += `<li>${r.trader.name}: ${r.standing}</li>`);
                        // Phase 3: Added reward images
                        if(rew.items) rew.items.forEach(i => html += `
                            <li class="flex items-center gap-2 mb-1">
                                <img src="${i.item.gridImageLink || ''}" class="w-5 h-5 object-contain bg-black/50 rounded" onerror="this.style.display='none'">
                                <span>${i.item.name} x${i.count}</span>
                            </li>`);
                        return html ? `<div class="mt-2"><h4 class="text-xs font-bold text-gray-500 uppercase">${type}</h4><ul class="list-none text-xs text-gray-400">${html}</ul></div>` : '';
                    };
                    rewardsHtml += processRew(t.startRewards, 'Start Rewards');
                    rewardsHtml += processRew(t.finishRewards, 'Finish Rewards');
                    
                    let sherpaData = this.consts.sherpaIntelDB[t.name];
                    let sherpaAdvice = "";
                    if (sherpaData) {
                        if(typeof sherpaData === 'string') {
                            sherpaAdvice = sherpaData; // Legacy compatibility
                        } else {
                            sherpaAdvice = sherpaData.desc;
                            if(sherpaData.tips && sherpaData.tips.length > 0) {
                                sherpaAdvice += `<ul class="list-none mt-2 space-y-1">${sherpaData.tips.map(tip => `<li class="text-xs text-blue-300"><i class="fa-solid fa-angle-right mr-1"></i>${tip}</li>`).join('')}</ul>`;
                            }
                        }
                    } else {
                        sherpaAdvice = "No specific advice available.";
                    }

                    return `
                    <div class="glass-panel rounded overflow-hidden border-l-2 ${t.kappaRequired ? 'border-tarkov-accent' : 'border-gray-600'}">
                        <div class="task-accordion-header p-3 flex flex-col sm:flex-row sm:items-center gap-2 cursor-pointer hover:bg-white/5" data-task-id="${t.id}" onclick="app.toggleTaskAccordion(this)">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-tarkov-accent rounded border-gray-600 bg-gray-700 focus:ring-tarkov-accent" onclick="event.stopPropagation(); app.toggleTaskCompleted('${t.id}')" ${t.completed ? 'checked' : ''}>
                            <div class="flex-1">
                                <div class="text-[10px] text-gray-500 uppercase flex items-center gap-2"><span>${t.trader?.name}</span>${t.minPlayerLevel ? '<span class="bg-gray-800 px-1 rounded">Lvl '+t.minPlayerLevel+'</span>' : ''}</div>
                                <div class="font-bold text-sm text-gray-200">${t.name}</div>
                                <div class="text-xs text-gray-500"><i class="fa-solid fa-map-location-dot mr-1"></i>${t.map?.name || 'Any'}</div>
                            </div>
                            <div class="flex items-center gap-3 mt-2 sm:mt-0">
                                ${t.kappaRequired ? '<span class="px-2 py-0.5 bg-yellow-900/40 text-tarkov-accent text-[10px] font-bold rounded border border-yellow-800/50">KAPPA</span>' : ''}
                                <i class="task-accordion-icon fa-solid fa-chevron-down transform transition-transform duration-300 ml-auto"></i>
                            </div>
                        </div>
                        <div class="task-accordion-content overflow-hidden max-h-0 transition-all duration-300 ease-in-out bg-black/20">
                            <div class="p-4 border-t border-gray-800 space-y-4">
                                <div><h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Objectives</h3><ul class="list-disc pl-4 space-y-1 text-sm text-gray-300">${t.objectives?.map(o => `<li>${o.description}</li>`).join('') || '<li>Check wiki</li>'}</ul></div>
                                ${rewardsHtml}
                                <div class="bg-blue-900/10 border-l-4 border-blue-600 p-3">
                                    <h3 class="text-xs font-bold text-blue-400 uppercase mb-1">Sherpa Advice</h3>
                                    <div class="text-sm text-gray-300 leading-relaxed">${sherpaAdvice}</div>
                                </div>
                                <div class="pt-2"><a href="${t.wikiLink || '#'}" target="_blank" class="text-sm text-tarkov-accent hover:underline flex items-center gap-2">Wiki Link <i class="fa-solid fa-external-link-alt"></i></a></div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },

            renderAmmo() {
                const tbody = document.getElementById('ammo-table-body');
                if(!tbody) return; // Guard clause
                
                tbody.innerHTML = this.data.ammo.slice(0, 50).map(a => `
                    <tr class="hover:bg-white/5 border-b border-gray-800"><td class="px-4 py-3 font-mono text-xs text-gray-500">${a.item.name}</td><td class="px-4 py-3 font-bold text-gray-200">${a.item.name}</td><td class="px-4 py-3 text-gray-400">${a.damage}</td><td class="px-4 py-3 ${a.penetrationPower > 40 ? 'text-red-400 font-bold' : 'text-yellow-500'}">${a.penetrationPower}</td><td class="px-4 py-3 text-gray-500">${a.armorDamage}</td></tr>
                `).join('');
            },

            // --- UTILITIES ---
            switchTab(id) {
                ['dashboard', 'tasks', 'gunsmith', 'hideout', 'ammo', 'market'].forEach(t => document.getElementById(`view-${t}`)?.classList.add('hidden'));
                document.getElementById(`view-${id}`).classList.remove('hidden');
                document.querySelectorAll('.nav-btn-desktop').forEach(b => {
                    const active = b.dataset.target === id;
                    b.classList.toggle('bg-tarkov-border', active);
                    b.classList.toggle('text-tarkov-accent', active);
                    b.classList.toggle('border-tarkov-accent', active);
                    b.classList.toggle('border-transparent', !active);
                });
                document.querySelectorAll('.nav-btn-mobile').forEach(b => {
                    const active = b.dataset.target === id;
                    b.classList.toggle('mobile-nav-active', active);
                    b.classList.toggle('text-gray-500', !active);
                });
                document.getElementById('main-content').scrollTop = 0;
            },

            setupListeners() {
                // Task Filters (Phase 4: Added map filter)
                ['task-search', 'filter-trader', 'filter-map', 'filter-type', 'hide-completed', 'sort-by'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.addEventListener(id === 'task-search' ? 'input' : 'change', () => this.renderTasks());
                });
                
                // Market Search Input
                const ms = document.getElementById('market-search');
                if(ms) ms.addEventListener('input', () => this.renderMarket());
                
                // Market Categories
                document.querySelectorAll('#market-category-filters button').forEach(b => b.addEventListener('click', (e) => {
                    document.querySelectorAll('#market-category-filters button').forEach(bb => bb.classList.remove('active', 'text-white'));
                    e.target.classList.add('active', 'text-white');
                    this.data.marketConfig.category = e.target.dataset.type;
                    this.renderMarket();
                }));
                
                // Craft Filters
                document.querySelectorAll('#craft-filters button').forEach(b => b.addEventListener('click', (e) => {
                    document.querySelectorAll('#craft-filters button').forEach(bb => bb.classList.remove('active', 'text-white'));
                    e.target.classList.add('active', 'text-white');
                    this.data.marketConfig.station = e.target.dataset.station;
                    this.renderCrafts();
                }));
            },

            toggleTaskAccordion(header) {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.task-accordion-icon');
                if (content.style.maxHeight) { content.style.maxHeight = null; icon.classList.remove('rotate-180'); }
                else { content.style.maxHeight = content.scrollHeight + "px"; icon.classList.add('rotate-180'); }
            },

            toggleTaskCompleted(taskId) {
                const idx = this.data.tasks.findIndex(t => t.id === taskId);
                if (idx !== -1) {
                    this.data.tasks[idx].completed = !this.data.tasks[idx].completed;
                    this.saveTaskCompletionStatus();
                    this.renderTasks();
                    // Phase 3: Update Market view to reflect new status
                    if(!document.getElementById('view-market').classList.contains('hidden')) {
                        this.renderMarket();
                    }
                }
            },

            loadTaskCompletionStatus() {
                const s = localStorage.getItem('taskCompletionStatus');
                if (s) { const map = JSON.parse(s); this.data.tasks.forEach(t => t.completed = map[t.id] || false); }
            },

            saveTaskCompletionStatus() {
                const map = {}; this.data.tasks.forEach(t => { if(t.completed) map[t.id] = true; });
                localStorage.setItem('taskCompletionStatus', JSON.stringify(map));
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.classList.remove('opacity-0', 'pointer-events-none');
                t.classList.add('animate-bounce');
                setTimeout(() => { t.classList.add('opacity-0', 'pointer-events-none'); t.classList.remove('animate-bounce'); }, 2500);
            }
        };

        app.init();
    </script>
</body>
</html>
